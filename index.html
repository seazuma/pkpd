<!DOCTYPE html>
<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>pkpd</title>
<script>
// for debug
var DB;
function d(x){return document.getElementById(x);}
// how to write code for old browsers:
// https://www.yunabe.jp/docs/javascript_class_in_google.html

// mg/L = mcg/mL で計算し、出力の時に調整している

/* setting */

var H = 280, W = 750, O_x = 100, O_y = 30;
var row_H = 30;
var cAX1 = "#666666", cAX2 = "#aaaaaa"; // axis color
var cCH = "#333333"; // char color
var cBG = "#eeffff"; // bg-color
var ctx_font_size = 12;
var ctx_font = ctx_font_size + "px serif";

var Compart_color_list = ["red","blue","green"]; // for canvas2
var CompLineWidth = 80;

var Date_now = new Date();
var Scale = {
 is_moving: false,
 t_scale_300: 60, // time[min] per 300 px
 t_scale: 0.2, // time[min] per px
 t1: Date_now.getHours()*60, // time at origin
 dx : 1, // plot_interval [px]
 x_list: [],
 ready: function(){
  var x;
  for(x=0; x<W; x+=this.dx){
   this.x_list.push(x);
 }},
 update: function(t1, t_300){
  this.is_moving = false;
  this.t1 = t1;
  this.t_scale_300 = t_300;
  this.t_scale = t_300/300;
  this.t0 = x2t(0); // time at left edge
  this.t2 = x2t(W); // time at right edge
 }
};

var UnitInfo = function(is_infusion, is_per_kg, is_per_mL, mg_per_val){
 this.is_infusion = is_infusion;
 this.is_per_kg = is_per_kg; 
 this.is_per_mL = is_per_mL;
 this.mg_per_val = mg_per_val;
};
UnitInfo.prototype.calc_mg_per_val = function(TBW, mgmL){
 var ret = this.mg_per_val;
 if(this.is_per_kg) ret *= TBW;
 if(this.is_per_mL) ret *= mgmL;
 return ret;
}
var UnitInfoList = {};
UnitInfoList["mg"] = new UnitInfo(false, false, false, 1);
UnitInfoList["mg/kg"] = new UnitInfo(false, true, false, 1);
UnitInfoList["mcg"] = new UnitInfo(false, false, false, 1/1000);
UnitInfoList["mL"] = new UnitInfo(false, false, true, 1);
UnitInfoList["mg/h"] = new UnitInfo(true, false, false, 1);
UnitInfoList["mg/kg/h"] = new UnitInfo(true, true, false, 1);
UnitInfoList["mcg/kg/min"] = new UnitInfo(true, true, false, 60/1000);
UnitInfoList["mcg/kg/h"] = new UnitInfo(true, true, false, 1/1000);
UnitInfoList["mL/h"] = new UnitInfo(true, false, true, 1);

UnitInfoList["ng/mL"] = new UnitInfo(true, false, false, 1/1000);
UnitInfoList["mcg/mL"] = new UnitInfo(true, false, false, 1);

var AgentInfo = function(agent_fullname, bolus_unit, infusion_unit, mgmL, y_scale_50, color){
 this.agent_fullname = agent_fullname;
 this.bolus_unit = bolus_unit;
 this.infusion_unit = infusion_unit;
 this.mgmL = mgmL;
 this.y_scale_50 = y_scale_50; // ng/mL at first horizontal line
 this.color = color;
 this.model_list = [];
 this.active_model_g = null;
 this.row_list = [];
}
function copyAgentInfo(agentinfo){
 var new_agentinfo = new AgentInfo(agentinfo.agent_fullname, agentinfo.bolus_unit, agentinfo.infusion_unit, agentinfo.mgmL, agentinfo.y_scale_50, agentinfo.color);
 new_agentinfo.model_list = agentinfo.model_list;
 new_agentinfo.active_model_g = agentinfo.active_model_g;
 new_agentinfo.row_list = [];
 return new_agentinfo;
}

var AgentInfoList = {};
AgentInfoList["P"] = new AgentInfo("Propofol","mg","mcg/mL", 10, 1000, "#0000ff"); // blue
AgentInfoList["RMZ"] = new AgentInfo("Remimazolam","mg","mg/h", 1, 1000, "#800080"); // purple
AgentInfoList["K"] = new AgentInfo("Ketamine","mL","mL/h", 10,1000, "#008000"); //green
AgentInfoList["DEX"] = new AgentInfo("Dexmedetomidine","mL","mcg/kg/h", 0.004, 1, "#008080"); //teal
AgentInfoList["F"] = new AgentInfo("Fentanyl","mL","mL/h", 0.05, 1, "#ff0000"); //red
AgentInfoList["RF"] =  new AgentInfo("Remifentanil","mL","mL/h", 0.1, 1, "#808000"); // olive
AgentInfoList["Rb"] =  new AgentInfo("Rocuronium","mg","mg/h", 10,500, "#800000"); // maroon
AgentInfoList["Vb"] =  new AgentInfo("Vecuronium","mg","mg/h", 1,50, "#ff00ff"); // fuchsia

/* model */

var Model = function(){};
function model_from_VQ(V1,V2,V3,CL,Q2,Q3,ke){
 var model = new Model();
 model.V1=V1; model.V2=V2; model.V3=V3; model.CL=CL; model.Q2=Q2; model.Q3=Q3; model.ke = ke;
 model.k10 = CL/V1; model.k12 = Q2/V1; model.k13 = Q3/V1; model.k21 = Q2/V2; model.k31 = Q3/V3;
 model.set_common();
 return model;
}
function model_from_k(k10,k12,k13,k21,k31,ke,V1){
 var model = new Model();
 model.k10=k10; model.k12=k12; model.k13=k13; model.k21=k21; model.k31=k31; model.ke = ke; model.V1 = V1;
 model.CL = k10*V1; model.Q2 = k12*V1; model.Q3 = k13*V1; model.V2 = model.Q2/k21; model.V3 = model.Q3/k31;
 model.set_common();
 return model;
}
Model.prototype.set_common = function(){
 var a = this.k10+this.k12+this.k13+this.k21+this.k31;
 var b = this.k10*(this.k21+this.k31)+this.k12*this.k31+this.k13*this.k21+this.k21*this.k31;
 var c = this.k10*this.k21*this.k31;
 this.eigen = solve3(a,b,c);
 this.c20=this.k12/(this.eigen[0]+this.k21); this.c21=this.k12/(this.eigen[1]+this.k21); this.c22=this.k12/(this.eigen[2]+this.k21);
 this.c30=this.k13/(this.eigen[0]+this.k31); this.c31=this.k13/(this.eigen[1]+this.k31); this.c32=this.k13/(this.eigen[2]+this.k31);
 this.ce0=this.ke/(this.eigen[0]+this.ke); this.ce1=this.ke/(this.eigen[1]+this.ke); this.ce2=this.ke/(this.eigen[2]+this.ke);
};
/*
eigen: zero of characteristic polynomial; X^3 + (k10+k12+k13+k21+k31)X^2 +(k10*k21+k10*k31+k12*k31+k13*k21+k21*k31)X + k10*k21*k31
c2k,c3k,cek: coefficients satisfying following:
A1 = \sum_{k=1..3} coeff[k]*exp(eigen[k]*t)
A2 = \sum_{k=1..3} (c2k := k12/(eigen[k]+k21)) * coeff[k]*exp(eigen[k]*t)
A3 = \sum_{k=1..3} (c3k := k13/(eigen[k]+k31)) * coeff[k]*exp(eigen[k]*t)
C1 = \sum_{k=1..3} coeff[k]*exp(eigen[k]*t) / V1
Ce = coeff_e*exp(-ke) + \sum_{k=1..3} (cek := ke0/(eigen[k]+ke0)) * coeff[k]*exp(eigen[k]*t) / V1
*/
function model_from_eigen(eigen,V1,V123,CL,ke){
 var b = -V1/CL*(V123/CL*eigen[0]*eigen[1]*eigen[2]+eigen[0]*eigen[1]+eigen[1]*eigen[2]+eigen[2]*eigen[0]),
 c = -V1/CL*eigen[0]*eigen[1]*eigen[2],
 sqrtD = Math.sqrt(b*b-4*c),
 k21 = (-b+sqrtD)/2,
 k31 = (-b-sqrtD)/2,
 k12 = -(k21+eigen[0])*(k21+eigen[1])*(k21+eigen[2]) / (k21*k21+V1/CL*eigen[0]*eigen[1]*eigen[2]),
 k13 = -(k31+eigen[0])*(k31+eigen[1])*(k31+eigen[2]) / (k31*k31+V1/CL*eigen[0]*eigen[1]*eigen[2]),
 k10 = CL/V1;
 return model_from_k(k10,k12,k13,k21,k31,ke,V1);
}
/* k10,k12,k13,k21,k31 satisfy following equations:
k10 = CL/V1
1 + k12/k21 + k13/k31 = V123/V1
k10+k12+k13+k21+k31 = - (e1+e2+e3)
k10*k21+k10*k31+k12*k31+k13*k21+k21*k31 = e1*e2+e2*e3+e3*e1
k10*k21*k31 = - e1*e2*e3
They can be obtained as:
k21,k31 are roots of X^2-V1/CL*(V123/CL*e1*e2*e3+e1*e2+e2*e3+e3*e1)*X-V1/CL*e1*e2*e3 = 0
k12 = -(k21+e1)*(k21+e2)*(k21+e3) / (k21^2+V1/CL*e1*e2*e3),
k13 = -(k31+e1)*(k31+e2)*(k31+e3) / (k31^2+V1/CL*e1*e2*e3).
*/

var model_P_E2018 = function(patient){ // Eleveld 2018 (ignore terms of maturation, assume presence of opiates)
 var theta = [0,6.28,25.5,273,1.79,1.75,1.11,0.191,42.3,9.06,-0.0156,-0.00286,33.6,-0.0138,68.3,2.10,1.30,1.42,0.68]
 theta_pd = [0,2.91,0.121,92.3,1.44,7.59,0.0499,-0.00917,0.87,1.83],
 fcentral = function(x){ return x/(x+theta[12]); },
 FFM = patient.FFM_AS,
 FFMref = (0.88+(1-0.88)/(1+Math.pow(35/13.4,-12.7)))*(9270*70/(6680+216*70*10000/(170*170))),
 V1 = theta[1] * fcentral(patient.TBW)/fcentral(70),
 V2 = theta[2] * patient.TBW/70 * Math.exp(theta[10]*(patient.age-35)),
 V3 = theta[3] * FFM/FFMref * Math.exp(theta[13]*(patient.age-35)),
 CL = (patient.sex==0?theta[4]:theta[15])*Math.pow(patient.TBW/70,0.75)*Math.exp(theta[11]*patient.age),
 Q2 = theta[5] * Math.pow(patient.TBW/70 * Math.exp(theta[10]*(patient.age-35)),0.75),
 Q3 = theta[6] * Math.pow(patient.TBW/70 * Math.exp(theta[13]*(patient.age-35)),0.75),
 ke = theta_pd[2] * Math.pow(patient.TBW/70,-0.25);
 return model_from_VQ(V1,V2,V3,CL,Q2,Q3,ke);
};
var model_P_M1991 = function(patient){ // Marsh,1991 & Diprifusor
 return model_from_k(0.119, 0.112, 0.0419, 0.055, 0.0033, 0.260, 0.228*patient.TBW);
}
var model_RMZ_M2022 = function(patient){ // Masui, 2022
 var age = patient.age; var sex = patient.sex; var ABW = patient.ABW; var high_ASA = patient.high_ASA;
 var theta = [0, 3.57, 11.3, 27.2, 1.03, 1.10, 0.401, 1.19, 0.308, 0.146, -0.184, 0.0205];
 var V1 = theta[1]*ABW/67.3;
 var V2 = theta[2]*ABW/67.3;
 var V3 = (theta[3]+theta[8]*(age-54))*ABW/67.3;
 var CL = (theta[4]+theta[9]*sex*theta[10]*high_ASA) * Math.pow(ABW/67.3,0.75);
 var Q2 = theta[5] * Math.pow(ABW/67.3,0.75);
 var Q3 = theta[6] * Math.pow(ABW/67.3,0.75);
 return model_from_VQ(V1,V2,V3,CL,Q2,Q3,0.22);
}
var model_RMZ_D2014 = function(patient){
 return model_from_eigen([Math.log(1/2)/0.62,Math.log(1/2)/10,Math.log(1/2)/47], 0.044*patient.TBW, 0.53*patient.TBW, 0.0174*patient.TBW, 0);
// equivalent to model_from_k(0.3954545454545455,0.4931482469720125,0.1612302782489611,0.1299739456706474,0.02223483754595047,0,0.044*patient.TBW);
}
var model_K_K2020 = function(patient){ // Kamp, 2020
 var V1 = 21 * patient.TBW/70,
 V2 = 46 * patient.TBW/70,
 V3 = 254 * patient.TBW/70,
 CL = 79 * Math.pow(patient.TBW/70,0.75) / 60, /* convert L/h to L/min */
 Q2 = 97 * Math.pow(patient.TBW/70,0.75) / 60,
 Q3 = 60 * Math.pow(patient.TBW/70,0.75) / 60;
 return model_from_VQ(V1,V2,V3,CL,Q2,Q3,0);
}
var model_DEX_M2020 = function(patient){ // Morse, 2020
 var FFM_AS = patient.FFM_AS,
 V1 = 25.2 * FFM_AS/70,
 V2 = 34.4 * FFM_AS/70,
 V3 = 65.4 * FFM_AS/70,
 CL = 0.897 * Math.pow(FFM_AS/70, 0.75),
 Q2 = 1.68 * Math.pow(FFM_AS/70, 0.75),
 Q3 = 0.62 * Math.pow(FFM_AS/70, 0.75);
 return model_from_VQ(V1,V2,V3,CL,Q2,Q3,0);
};
var model_DEX_H2015 = function(patient){ // Hannivoort, 2015
 var V1 = 1.78 * patient.TBW/70,
 V2 = 30.3 * patient.TBW/70,
 V3 = 52 * patient.TBW/70,
 CL = 0.686 * Math.pow(patient.TBW/70, 0.75),
 Q2 = 2.98 * Math.pow(V2/30.3, 0.75),
 Q3 = 0.602 * Math.pow(V3/52, 0.75);
 return model_from_VQ(V1,V2,V3,CL,Q2,Q3,0);
};
var model_F_B2020 = function(patient){ // Bae, 2020 PMID: 32861508
 var V1 = 10.1 * Math.pow(patient.TBW/70,1.23),
 V2 = 26.5 * Math.pow(patient.TBW/70,1.23),
 V3 = 206 * Math.pow(patient.TBW/70,1.23),
 CL = 0.704 * Math.pow(patient.TBW/70, 0.313),
 Q2 = 2.38 * Math.pow(V2/30.3, 0.313),
 Q3 = 1.49 * Math.pow(V3/52, 0.313);
 ke = 0.147;
 return model_from_VQ(V1,V2,V3,CL,Q2,Q3,ke);
};
var model_F_S1990 = function(patient){ // Shafer,1990
  return model_from_k(0.083,0.471,0.225,0.102,0.006,0.114,0.105*patient.TBW);
};
var model_RF_E2017 = function(patient){ // Eleveld, 2017
 var FFM_AS = patient.FFM_AS,
 FFMref = (0.88+(1-0.88)/(1+Math.pow(35/13.4,-12.7)))*(9270*70/(6680+216*70*10000/(170*170))),
 Fsize = FFM_AS / FFMref,
 Fsigmoid = function(x,b,c){return Math.pow(x,c)/(Math.pow(x,c)+Math.pow(b,c));},
 Fsex = patient.sex==0?1:1+0.47*Fsigmoid(patient.age,12,6) * (1-Fsigmoid(patient.age,45,6)),
 V1 = 5.81*Fsize*Math.exp(-0.00554*(patient.age-35)),
 V2 = 8.82*Fsize*Math.exp(-0.00327*(patient.age-35)) * Fsex,
 V3 = 5.03*Fsize*Math.exp(-0.0315*(patient.age-35)) * Math.exp(-0.0260*(patient.TBW-70)),
 CL = 2.58*Math.pow(Fsize,0.75)*Math.exp(-0.00554*(patient.age-35)) * Fsex,
 Q2 = 1.72*Math.pow(V2/8.82,0.75)*Math.exp(-0.00554*(patient.age-35)) * Fsex,
 Q3 = 0.124*Math.pow(V3/5.03,0.75)*Math.exp(-0.00554*(patient.age-35)),
 ke = 1.09*Math.exp(-0.00289*(patient.age-35));
 return model_from_VQ(V1,V2,V3,CL,Q2,Q3,ke);
}
var model_RF_K2017 = function(patient){ // Kim, 2017
 V1 = 4.76*Math.pow(patient.TBW/74.5,0.658),
 V2 = 8.4*Math.pow(patient.FFM_j/52.3,0.573)-0.0936*(patient.age-37),
 V3 = 4-0.0477*(patient.age-37),
 CL = 2.77*Math.pow(patient.TBW/74.5,0.336)-0.0149*(patient.age-37),
 Q2 = 1.94-0.0280*(patient.age-37),
 Q3 = 0.197,
 ke = 0; // 0.595-0.007*(patient.age-40) if Minto,1997
 return model_from_VQ(V1,V2,V3,CL,Q2,Q3,ke);
}
var model_RF_M1997 = function(patient){ // Minto,1997
  var AGE = patient.age, LBM = patient.LBM;
  V1 = 5.1-0.0201*(AGE-40)+0.072*(LBM-55);
  V2 = 9.82-0.0811*(AGE-40)+0.108*(LBM-55);
  V3 = 5.42;
  CL = 2.6-0.0162*(AGE-40)+0.0191*(LBM-55);
  Q2 = 2.05-0.0301*(AGE-40);
  Q3 = 0.076-0.00113*(AGE-40);
  ke = 0.595-0.007*(AGE-40);
 return model_from_VQ(V1,V2,V3,CL,Q2,Q3,ke);
}
var model_Rb_W1991 = function(patient){ // Wierda,1991
 return model_from_k(0.1,0.21,0.028,0.13,0.01, 0 ,0.045*patient.TBW); 
}
var model_Vb_R1987 = function(patient){ // Rupp,1987
 if(patient.age<64){
  return model_from_k(0.1,0.1436,0.0344,0.1102,0.0144, 0.169 ,0.052*patient.TBW);
 } else{
  return model_from_k(0.0389,0.4368,0.107,0.0787,0.0039, 0.5923 ,0.029*patient.TBW);
 }
}

AgentInfoList["P"].model_list = [
 {model_g: model_P_E2018, label: "Eleveld,2018"},
 {model_g: model_P_M1991, label: "Marsh,1991"}
];
AgentInfoList["RMZ"].model_list = [
 {model_g: model_RMZ_M2022, label: "Masui,2022"},
 {model_g: model_RMZ_D2014, label: "Doi,2014"}
];
AgentInfoList["K"].model_list = [
 {model_g: model_K_K2020, label: "Kamp,2020"}
];
AgentInfoList["DEX"].model_list = [
 {model_g: model_DEX_M2020, label: "Morse,2020"},
 {model_g: model_DEX_H2015, label: "Hannivoort,2015"}
];
AgentInfoList["F"].model_list = [
 {model_g: model_F_B2020, label: "Bae, 2020"},
 {model_g: model_F_S1990, label: "Shafer,1990"}
];
AgentInfoList["RF"].model_list = [
 {model_g: model_RF_E2017, label: "Eleveld,2017"},
 {model_g: model_RF_K2017, label: "Kim,2017"},
 {model_g: model_RF_M1997, label: "Minto,1997"}
];
AgentInfoList["Rb"].model_list = [
 {model_g: model_Rb_W1991, label: "Wierda,1991"}
];
AgentInfoList["Vb"].model_list = [
 {model_g: model_Vb_R1987, label: "Rupp,1987"}
];

/* patient */

var Current_patient;

var Patient = function(age,sex,height,TBW,high_ASA){
 /* sex: 0 (male) or 1 (female), height[cm], TBW[kg], ASA34: 0 (ASA-PS=1,2) or 1 (ASAPS=3,4) */
 this.age = age;
 this.sex = sex;
 this.height = height;
 this.BMI = TBW * 10000 / (height * height);
 this.TBW = TBW;
 this.IBW = 45.4+0.89*(height-152.4)+4.5*(1-sex);
 this.ABW = this.IBW+0.4*(TBW-this.IBW);
 this.LBM = sex==0? 1.1*TBW-128*(TBW/height)*(TBW/height): 1.07*TBW-148*(TBW/height)*(TBW/height);
 this.FFM_j = sex==0 ? 9270*TBW/(6680+216*this.BMI) : 9270*TBW/(8780+244*this.BMI); // Janmahasatian
 this.FFM_AS = sex==0 ? (0.88+(1-0.88)/(1+Math.pow(age/13.4,-12.7)))*this.FFM_j :
  (1.11+(1-1.11)/(1+Math.pow(age/7.1,-1.1)))*this.FFM_j; // Al Sallami et al.
 this.high_ASA = high_ASA;
};
function load_patient(){ // eventually check validity
 var age = parseFloat(document.getElementById("age").value);
 if(age<0){ age=1; document.getElementById("age").value=1; }
 var TBW = parseFloat(document.getElementById("TBW").value);
 if(TBW<0){ TBW=1; document.getElementById("TBW").value=1; }
 var height = parseFloat(document.getElementById("height").value);
 if(height<0){ height=1; document.getElementById("height").value=1; }
 var sex = parseFloat(document.getElementById("sex").value);
 var high_ASA = parseFloat(document.getElementById("high_ASA").value);
 Current_patient = new Patient(age,sex,height,TBW,high_ASA);
 document.getElementById("patient_info").innerHTML
 = "BMI:" + myPrecision(Current_patient.BMI)
  + ", IBW:" + myPrecision(Current_patient.IBW)
  + ", ABW:" + myPrecision(Current_patient.ABW)
  + ", LBM:" + myPrecision(Current_patient.LBM)
  + ", FFM<sub>j</sub>:" + myPrecision(Current_patient.FFM_j)
  + ", FFM<sub>AS</sub>:" + myPrecision(Current_patient.FFM_AS)
}

/* general operation */

function appear(x){document.getElementById(x).style.display = "block"; }
function disappear(x){document.getElementById(x).style.display = "none"; }
function appear_disappear(x){ document.getElementById(x).style.display =  document.getElementById("area"+x).style.display=="none"?"block":"none";}
function setClass(x,y){ x.setAttribute("class",y);x.setAttribute("className",y); x.className=y;}
function myPrecision(x){// my display style
 return isNaN(x)? "":x<-0.0001? "-"+myPrecision(-x): x>=100? x.toFixed(0):x>=10? x.toFixed(1):x>=1? x.toFixed(2):x<0.0001? "0":x.toPrecision(2);
}
function myPrecision_signed(x){ var ret = myPrecision(x); return ret>0? "+"+ret: ret; }

function min2hm(t){
 if(t<0){ return "-"+min2hm(-t); }
 t = Math.floor(t);
 var h = Math.floor(t/60), m=t-h*60;
 return h + ":" + (m<10?"0"+m:m);
}
function hm2min(x){
 if(x.charAt(0)=="-"){ return -hm2min(x.substring(1)); }
 var hm = x.split(":");
 return hm.length==2? Math.floor( parseFloat(hm[0])*60 + parseFloat(hm[1]) ): NaN;
}
function ready(){ // onload function
 load_patient();
 canvas_ready();
 drug_list_ready();
 no_zoom();
 compart_ready();
}

/* sorted array */
// bisection method: https://note.affi-sapo-sv.com/js-insert-into-sorted-array.php

function insertValue2(val,array){
 var length = array.length;
 if( length === 0 || array[length-1] <= val ){
  array.push( val ); return length;
 }
 var left = 0,right = length;
 var index = Math.floor((left + right) / 2);
 while (right > left) {
  if(val < array[index]){ right = index; }
  else { left = index+1; }
  index = Math.floor((left + right) / 2);
 }
 array.splice(index, 0, val);
 return index;
}
function indexBelowValue2(val,array){
 var length = array.length;
 if( length === 0 || array[length-1] < val ){
  return length-1;
 }
 var left = 0, right = length;
 var index = Math.floor((left + right) / 2);
 while (right > left) {
  if(val < array[index]){ right = index; }
  else { left = index+1; }
  index = Math.floor((left + right) / 2);
 }
 return index-1;
}
function deleteValue2(val,array){
 var length = array.length;
 var left=0,right = length;
 var index = Math.floor((left + right) / 2);
 while (right > left) {
  if (val==array[index]){
   array.splice(index, 1); return index;
  }
  if(val < array[index]){ right = index; }
  else { left = index+1; }
  index = Math.floor((left + right) / 2);
 }
}

/* algebra */

function solve3x3(a1,b1,c1,a2,b2,c2,a3,b3,c3,d1,d2,d3){ // solve ak*x+bk*y+ck*z=dk
 var D = a1*(b2*c3-b3*c2)+a2*(b3*c1-b1*c3)+a3*(b1*c2-b2*c1);
 var x = ( d1*(b2*c3-b3*c2)+d2*(b3*c1-b1*c3)+d3*(b1*c2-b2*c1) )/ D
 var y = ( a1*(d2*c3-d3*c2)+a2*(d3*c1-d1*c3)+a3*(d1*c2-d2*c1) )/ D
 var z = ( a1*(b2*d3-b3*d2)+a2*(b3*d1-b1*d3)+a3*(b1*d2-b2*d1) )/ D
return [x,y,z];}

var Accuracy = 0.00001;
function solve3(a,b,c){
// solve x^3+ax^2+bx+c=0
// |x| < max(a,b,c)+1 as explained in https://mathclinic314.com/n%E6%AC%A1%E6%96%B9%E7%A8%8B%E5%BC%8F%E3%81%AE%E8%A7%A3%E3%81%AE%E9%99%90%E7%95%8C%E3%80%90%E6%8E%9B%E8%B0%B7%E3%81%AE%E5%AE%9A%E7%90%86%E3%80%91%E3%80%901975%E5%B9%B4%E5%BA%A6%E6%97%A9%E7%A8%B2/
// Strum method, F0=[c,b,a,1]; F1=[b,2*a,3]; F2=[b*a-c*9, 2*a*a-6*b]; F3=[a*a*b*b-27*c*c-4*a*a*a*c-4*b*b*b+18*a*b*c];
// assume a,b,c,D > 0
 var D = (a*a*b*b-27*c*c-4*a*a*a*c-4*b*b*b+18*a*b*c);
 function strum_n(x){
  var f0x = c+x*(b+x*(a+x));
  var f1x = b+x*(2*a+3*x);
  var f2x = b*a-c*9 + x*(2*a*a-6*b);
  return (f0x*f1x<0?1:0) + (f1x*f2x<0?1:0) + (f2x*D<0?1:0);
 }
 var root = [];
 var stack = [];
 var lower = -Math.max(a,b,c)-1, upper=0, s_lower = strum_n(lower), s_upper=strum_n(upper);
 stack[0]=[lower,upper,s_lower,s_upper];
 var pointer=0;
 while(pointer>=0){
  var work = stack[pointer]
  lower = work[0];
  upper = work[1];
  var middle = (lower+upper)/2;
  s_lower = work[2];
  s_upper = work[3];
  if(s_upper==s_lower){ pointer--; continue; }
  if(upper-lower < Accuracy){
   var j;
   for(j=0;j<s_lower-s_upper;j++) root.push(middle);
   pointer--; continue;
  }
  s_middle = strum_n(middle);
  stack[pointer] = [lower,middle,s_lower,s_middle];
  stack[pointer+1] = [middle,upper,s_middle,s_upper];
  pointer++;
 }
 return root;
}

/* agentinfo management */

var Agent_list = [];
var Agent_index = {}; // idx=Agent_index[str] such that Agent_list[idx] = str

AgentInfo.prototype.add_row = function(row){
 var agent = row.agent;
 this.row_list.push(row);
 if(Agent_index[agent]===undefined){
  var idx = Agent_list.length;
  Agent_index[agent] = idx;
  Agent_list.push(agent);
  create_CA_div(idx);
}}
AgentInfo.prototype.delete_row = function(row){
 var agent = row.agent;
 var i; for(i=this.row_list.length-1;i>=0;i--){
  if(this.row_list[i] === row){
   this.row_list.splice(i,1);
 }}
 if(this.row_list.length==0){
  var idx = Agent_index[agent];
  var i;
  for(i=idx; i<Agent_list.length-1; i++){
   Agent_list[i] = Agent_list[i+1];
   Agent_index [ Agent_list[i] ] = i; 
  }
  Agent_list.pop();
  delete Agent_index[agent];
  delete_CA_div(idx);
}}

/* main simulation */

var t_MIN = -999999999999999, t_MAX = 999999999999999;
/* Number.MIN_SAFE_INTEGER does not work in old browser */

var Solution = function(time, equibs, coeffs, infusion_rate, model){
 this.time = time;
 this.equibs = equibs.concat();
 this.coeffs = coeffs.concat();
 this.infusion_rate = infusion_rate;
 this.model = model;
};
function give_solution(t, C_list, infusion_rate, model){
 var equib_A1 = infusion_rate / model.k10;
 var equib_A2 = equib_A1 * model.k12 / model.k21;
 var equib_A3 = equib_A1 * model.k13 / model.k31;
 var coeffs = solve3x3(1,1,1,model.c20,model.c21,model.c22,model.c30,model.c31,model.c32, C_list[1]*model.V1-equib_A1,C_list[2]*model.V2-equib_A2,C_list[3]*model.V3-equib_A3);
 var coeff_e = C_list[0] * model.V1 - equib_A1 - model.ce0*coeffs[0] - model.ce1*coeffs[1] - model.ce2*coeffs[2];
 return new Solution(t, [equib_A1,equib_A2,equib_A3], coeffs.concat([coeff_e]), infusion_rate, model );
}
Solution.prototype.calc_e123 = function(t){
 var model = this.model;
 if(!model) return [0,0,0,0];
 var term_0 = this.coeffs[0] * Math.exp(model.eigen[0]*(t-this.time));
 var term_1 = this.coeffs[1] * Math.exp(model.eigen[1]*(t-this.time));
 var term_2 = this.coeffs[2] * Math.exp(model.eigen[2]*(t-this.time));
 var term_e = this.coeffs[3] * Math.exp(-model.ke*(t-this.time));
 var Ce = (this.equibs[0] + model.ce0*term_0 + model.ce1*term_1 + model.ce2*term_2 + term_e) / model.V1
 var C1 = (this.equibs[0] + term_0 + term_1 + term_2) / model.V1;
 var C2 = (this.equibs[1] + model.c20*term_0 + model.c21*term_1 + model.c22*term_2) / model.V2;
 var C3 = (this.equibs[2] + model.c30*term_0 + model.c31*term_1 + model.c32*term_2) / model.V3;
 return [Ce,C1,C2,C3]; 
};
var solution_zero = new Solution(t_MIN, [0,0,0], [0,0,0,0], [], null);

var Solution_TCI = function(total, wait_dt, solution_wait, time, equibs, coeffs, TCI_model, model){
 this.total = total;
 this.wait_dt = wait_dt;
 this.solution_wait = solution_wait;
 this.time = time;
 this.equibs = equibs.concat(); // 1,2,3
 this.coeffs = coeffs.concat(); // 1,2,3,e,2T,3T
 this.TCI_model = TCI_model;
 this.model = model;
};
function give_solution_TCI(t, C_list, TCI, TCI_model, model, total){
DB = [t, C_list, TCI, TCI_model, model,total];
/*
console.log(DB);
t = DB[0]
C_list = DB[1]
TCI = DB[2]
TCI_model = DB[3]
model = DB[4]
*/
 var wait_dt = 0;
 var TCI_solution_wait = give_solution(t, C_list, 0, TCI_model);
 var solution_wait = give_solution(t, C_list, 0, model);
 if(C_list[1] > TCI){
  if( TCI_solution_wait.calc_e123(Scale.t2)[1] > TCI ){
   return solution_wait;
  }
  var t_left = 0, t_right = Math.log(1/2)/model.eigen[2];
  while( TCI_solution_wait.calc_e123( t + t_right )[1] > TCI ){
   t_left = t_right; t_right+=Math.log(1/2)/model.eigen[2];
  }
  while(t_right-t_left > Accuracy){
   var wait_dt = (t_left + t_right)/2;
   if(TCI_solution_wait.calc_e123( t + wait_dt )[1] > TCI){ t_left = wait_dt; }
   else{ t_right = wait_dt; } 
  }
  C_list = TCI_solution_wait.calc_e123( t + wait_dt );
 }
 else if(C_list[1] < TCI){
  C_list[1] = TCI; // bolus
  total += model.V1 * (TCI-C_list[1]);
//console.log(bolus+"mg");
 }
 var TCI_equib_A1 = model.V1 * TCI; 
 var TCI_equib_A2 = TCI_equib_A1 * TCI_model.k12 / TCI_model.k21;
 var TCI_equib_A3 = TCI_equib_A1 * TCI_model.k13 / TCI_model.k31;
 var temp_coeff_2 = C_list[2] * TCI_model.V2 - TCI_equib_A2;
 var temp_coeff_3 = C_list[3] * TCI_model.V3 - TCI_equib_A3;
 var equib_A1 = TCI_model.k10 * TCI_equib_A1 / model.k10;
 var equib_A2 = equib_A1 * model.k12 / model.k21;
 var equib_A3 = equib_A1 * model.k13 / model.k31;
 var coeffs = solve3x3(1,1,1,model.c20,model.c21,model.c22,model.c30,model.c31,model.c32,
  C_list[1]*model.V1-equib_A1, C_list[2]*model.V2-equib_A2-temp_coeff_2, C_list[3]*model.V3-equib_A3-temp_coeff_3);
 var coeff_e = C_list[0] * model.V1 - equib_A1 - model.ce0*coeffs[0] - model.ce1*coeffs[1] - model.ce2*coeffs[2];
 return new Solution_TCI(total, wait_dt, solution_wait, t, [equib_A1,equib_A2,equib_A3], coeffs.concat([coeff_e,temp_coeff_2,temp_coeff_3]), TCI_model, model );
}
/*
A2_TCI = TCI_equib_A2 + temp_coeff_2*Math.exp(-TCI_model.k21*(t-this.time-this.wait_dt)) 
A3_TCI = TCI_equib_A3 + temp_coeff_3*Math.exp(-TCI_model.k31*(t-this.time-this.wait_dt))
infusion_rate = TCI_model.k10 * TCI_equib_A1
 - TCI_model.k21 * temp_coeff_2*Math.exp(-TCI_model.k21*(t-this.time-this.wait_dt)) ;
 - TCI_model.k31 * temp_coeff_3*Math.exp(-TCI_model.k31*(t-this.time-this.wait_dt)) ;
A1_simulation = \sum(c[k]*eigen[k])
A2_simulation = \sum(model.c2k*c[k]*eigen[k]) + temp_coeff_2*Math.exp(-TCI_model.k21*(t-this.time-this.wait_dt))
A3_simulation = \sum(model.c3k*c[k]*eigen[k]) + temp_coeff_3*Math.exp(-TCI_model.k31*(t-this.time-this.wait_dt))
*/

Solution_TCI.prototype.calc_e123 = function(t){
 var model = this.model;
 if(!model) return [0,0,0,0];
 if(t <= this.time + this.wait_dt){
  return this.solution_wait.calc_e123(t).concat([0,this.total]);
 }
 var term_0 = this.coeffs[0] * Math.exp(model.eigen[0]*(t-this.time-this.wait_dt));
 var term_1 = this.coeffs[1] * Math.exp(model.eigen[1]*(t-this.time-this.wait_dt));
 var term_2 = this.coeffs[2] * Math.exp(model.eigen[2]*(t-this.time-this.wait_dt));
 var term_e = this.coeffs[3] * Math.exp(-model.ke*(t-this.time-this.wait_dt));
 var term_2T = this.coeffs[4] * Math.exp(-this.TCI_model.k21*(t-this.time-this.wait_dt));
 var term_3T = this.coeffs[5] * Math.exp(-this.TCI_model.k31*(t-this.time-this.wait_dt));
 var Ce = (this.equibs[0] + model.ce0*term_0 + model.ce1*term_1 + model.ce2*term_2 + term_e) / model.V1
 var C1 = (this.equibs[0] + term_0 + term_1 + term_2) / model.V1;
 var C2 = (this.equibs[1] + model.c20*term_0 + model.c21*term_1 + model.c22*term_2 + term_2T) / model.V2;
 var C3 = (this.equibs[2] + model.c30*term_0 + model.c31*term_1 + model.c32*term_2 + term_3T) / model.V3;
 var Ci = (model.k10 * this.equibs[0] - this.TCI_model.k21 * term_2T - this.TCI_model.k31 * term_3T) * 60; // mg/min to mg/h
 var Ct = this.total + model.k10 * this.equibs[0] * (t-this.time-this.wait_dt) - (this.coeffs[4] - term_2T) - (this.coeffs[5] - term_3T);
//console.log([Ci, Ct])

 return [Ce,C1,C2,C3,Ci,Ct];
};

AgentInfo.prototype.calc_solutions_until = function(t2){
 var solution_list = [solution_zero];
 var current_solution = solution_zero;
 var current_infusion_rate_list = [];
 var rN = this.row_list.length;
 var mg_per_val_list = new Array(rN);
 var each_iv_list = new Array(rN);
 var each_pointer = new Array(rN);
 var ri;
 for(ri=0;ri<rN;ri++){
  each_iv_list[ri] = this.row_list[ri].entry_list.concat([t_MAX]);
  each_pointer[ri] = 0; 
  current_infusion_rate_list.push(0);
  mg_per_val_list[ri] = UnitInfoList[this.row_list[ri].unit].calc_mg_per_val(Current_patient.TBW, this.mgmL);
 }
 var TCI_model = null;
 if(this.TCI_model_g) TCI_model = this.TCI_model_g(Current_patient);
 while(true){
  var t_next = t_MAX;
  for(ri=0; ri<rN; ri++){
   t_next = Math.min(t_next, each_iv_list[ri][each_pointer[ri]]);
  }
  if( t_next >= t2 ){ break; }
  var model_next = (current_solution !== solution_zero)? current_solution.model: this.active_model_g(Current_patient);
  var bolus_next = 0, infusion_rate_next = 0;
  for(ri=0; ri<rN; ri++){
   if( t_next == each_iv_list[ri][each_pointer[ri]] ){
    if( this.row_list[ri].iv_dose_at[t_next] != undefined ){
     if( UnitInfoList[this.row_list[ri].unit].is_infusion ){
      current_infusion_rate_list[ri] = this.row_list[ri].iv_dose_at[t_next] * mg_per_val_list[ri]
     } else {
      bolus_next += this.row_list[ri].iv_dose_at[t_next] * mg_per_val_list[ri];
     }
    }
    if( this.row_list[ri].model_at[t_next] ){
     model_next = this.row_list[ri].model_at[t_next];
    }
    each_pointer[ri]++;
   }
   infusion_rate_next += current_infusion_rate_list[ri];
  }
  var C_next_list = [0,0,0,0,0,0]; // [Ce,C1,C2,C3]
  if(current_solution !== solution_zero){
   C_next_list = current_solution.calc_e123(t_next);
  }
  C_next_list[1] = C_next_list[1] + bolus_next/model_next.V1;
//console.log(model_next);
  var solution_next = TCI_model?
   give_solution_TCI(t_next, C_next_list, infusion_rate_next, TCI_model, model_next, C_next_list[5]):
   give_solution(t_next, C_next_list, infusion_rate_next/60, model_next); // mg/h --> mg/min
  solution_list.push(solution_next);
  current_solution = solution_next;
 }
 return solution_list;
}

function simulate(agentinfo, showCompart){
 var xN = Scale.x_list.length, xi=xN-1;
 var C1_list = new Array(xN);
 var Ce_list = new Array(xN);
 var sol_list = agentinfo.calc_solutions_until(Scale.t2);
 var si = sol_list.length - 1;
 while( xi>=0 ){
  var sol = sol_list[si]
  while( x2t(xi) >= sol.time && xi >= 0){
   if(sol === solution_zero){
    C1_list[xi] = 0; Ce_list[xi] = 0;
    if( showCompart ){
     Compart.model[xi] = sol.model;
     Compart.infusion_rate[xi] = 0;
     Compart.C1[xi] = 0;
     Compart.C2[xi] = 0;
     Compart.C3[xi] = 0;
    }
   }
   else{
    var model = sol.model; 
    var Ce123 = sol.calc_e123(x2t(xi));
    Ce_list[xi] = Ce123[0];
    C1_list[xi] = Ce123[1];
    if( showCompart ){
     Compart.model[xi] = sol.model;
     Compart.infusion_rate[xi] = sol.infusion_rate;
     Compart.C1[xi] = Ce123[1];
     Compart.C2[xi] = Ce123[2];
     Compart.C3[xi] = Ce123[3];
     if(agentinfo.TCI_model_g){
      Compart.TCI_infusion[xi] = Ce123[4];
      Compart.TCI_total[xi] = Ce123[5];
     }
    }
   }
   xi--;
  }
  si--;
 }
 return [C1_list,Ce_list];
}

/* row */

var Row_list = [];

var Row = function(div){
 this.div = div;
 this.PU_1_div = null;
 this.n = Row_list.length? Row_list[Row_list.length-1].n + 1 : 0; // id
 Row_list.push(this); 
 this.agent = "";
 this.unit = "";
 this.entry_list = [];
 this.iv_dose_at = {};
 this.model_at = {};
}
Row.prototype.delete = function(){ // delete this
 AgentInfoList[this.agent].delete_row(this);
 var n = this.n;
 var i,idx = n;
 for(i=idx;i<Row_list.length-1;i++){
  Row_list[i] = Row_list[i+1];
  Row_list[i].n = i;
 }
 Row_list.pop();
};
Row.prototype.add_data = function(time,dose,model){
 if(dose != null){
  this.iv_dose_at[time] = dose;
 }
 if(model != null){
  this.model_at[time] = model;
 }
 var idx = insertValue2(time, this.entry_list); // keep sorted
 return idx;
};
Row.prototype.delete_data = function(time){
 delete(this.iv_dose_at[time])
 delete(this.model_at[time])
 deleteValue2( time, this.entry_list);
};
Row.prototype.update_value = function(new_unit, new_mgmL){
 var t;
 var old_mgmL = AgentInfoList[this.agent].mgmL;
 var old_unit = this.unit;
 for(t in this.iv_dose_at){
  var val = this.iv_dose_at[t];
  var mg = val * UnitInfoList[old_unit].calc_mg_per_val(Current_patient.TBW, old_mgmL);
  var new_val = mg / UnitInfoList[new_unit].calc_mg_per_val(Current_patient.TBW, new_mgmL);
  this.iv_dose_at[t] = new_val;
 }
 var dose_each_list = this.div.children;
 var i; for(i=0;i<dose_each_list.length;i++){
  var div = dose_each_list[i];
  if(div.hasAttribute("time")){
   t = parseInt(div.getAttribute("time"))
   if(this.iv_dose_at[t]!==undefined){
    div.innerHTML = ( UnitInfoList[this.unit].is_infusion && this.iv_dose_at[t]==0? "/":
 myPrecision(this.iv_dose_at[t]) + (UnitInfoList[this.unit].is_infusion && this.iv_dose_at[t]?"-":"")
 ) + (this.model_at[t]?"#":"");
    
 }}}
 this.unit = new_unit;
 AgentInfoList[this.agent].mgmL = new_mgmL;
 this.div.lastChild.innerHTML = this.agent + "("+this.unit+")"; 
};

/* may be implemented in future
function copyRow(n1, n2){
 for(key in Row_list[n1]){
  if(key != "n"){
   Row_list[n2][key] = Row_list[n1][key]
  }
 }
}
*/

/* canvas */

var canvas_1, ctx_1;
var canvas_1_cursor, ctx_1_cursor;
var canvas_2, ctx_2;
var canvas_2_cursor, ctx_2_cursor;

function x2t(x){ return Scale.t1 + (x-O_x)*Scale.t_scale; }
function t2x(t){
 var x = parseInt(O_x + (t-Scale.t1)/Scale.t_scale);
 return 0<=x&&x<=W ? x : -999;
}

function canvas_ready(){
 Scale.ready();
 canvas_1 = document.getElementById('canvas_1'); // graph
 if ( ! canvas_1 || ! canvas_1.getContext ) { return false; }
 canvas_1_cursor = document.getElementById('canvas_1_cursor'); // mouse_event, dynamic layer
 canvas_2 = document.getElementById('canvas_2'); // compartment
 canvas_2_cursor = document.getElementById('canvas_2_cursor');
 canvas_1.width = W;
 canvas_1.height = H;
 canvas_1_cursor.width = W;
 canvas_1_cursor.height = H;
 canvas_2.width = W;
 canvas_2.height = H;
 canvas_2_cursor.width = W;
 canvas_2_cursor.height = H;
 canvas_1_cursor.onclick = function(e){
  var MouseRect = e.target.getBoundingClientRect();
  var x = e.clientX - MouseRect.left;
  var y = e.clientY - MouseRect.top;
  canvas1_cross( x,y, true );
 };
 canvas_1_cursor.ondblclick = function(e){
  scale_now();
 };
 canvas_1_cursor.ondragstart = function(){ return false; };
 canvas_1_cursor.onmousedown = function(e) {
  Scale.is_moving = true;
  Scale.moving_from = e.pageX;
 };
 canvas_1_cursor.onmousemove = function(e) {
  if(Scale.is_moving){
   draw_moving_x_axis(ctx_1_cursor, e.pageX - Scale.moving_from);
  } else {
   var MouseRect = e.target.getBoundingClientRect();
   var x = e.clientX - MouseRect.left;
   var y = e.clientY - MouseRect.top;
   canvas1_cross( x,y, false );
 }};
 canvas_1_cursor.onmouseup = function(e) { if(Scale.is_moving){
   ctx_1_cursor.clearRect(0, 0, W, H);
   update_x_axis(Scale.t1 - (e.pageX - Scale.moving_from)*Scale.t_scale, Scale.t_scale_300);
   Scale.is_moving = false;
   delete(Scale.moving_from);
 }};
 canvas_1_cursor.onmouseout = function() {
  if(Scale.is_moving){
   Scale.is_moving = false;
   delete(Scale.moving_from);
  } else {
   ctx_1_cursor.clearRect(0, 0, W, H);
   ctx_2_cursor.clearRect(0, 0, W, H);
   Canvas1CrossFix = false;
 }};
 if(canvas_1_cursor.addEventListener) {
  canvas_1_cursor.addEventListener('touchstart', canvas_1_touchstart, false);
  canvas_1_cursor.addEventListener('touchmove', canvas_1_touchmove, false);
  canvas_1_cursor.addEventListener('touchend', canvas_1_touchend, false);
 }
 else if(canvas_1_cursor.attachEvent) {
  canvas_1_cursor.attachEvent('touchstart', canvas_1_touchstart, false);
  canvas_1_cursor.attachEvent('touchmove', canvas_1_touchmove, false);
  canvas_1_cursor.attachEvent('touchend', canvas_1_touchend, false);
 }
 ctx_1 = canvas_1.getContext('2d');
 ctx_1_cursor = canvas_1_cursor.getContext('2d');
 ctx_2 = canvas_2.getContext('2d');
 ctx_2_cursor = canvas_2_cursor.getContext('2d');
 update_x_axis(Scale.t1, Scale.t_scale_300);
// delete childnodes in case user has downloaded loaded HTML 
 var div = document.getElementById("drug_row_container");
 while (div.firstChild) { div.removeChild(div.lastChild); }
 create_new_drug_row();
}
function draw_moving_x_axis(ctx, dx){
 ctx.clearRect(0, 0, W, H);
 ctx.fillStyle = "red";
 ctx.strokeStyle = "red";
 var x;
 for(t=Scale.t1; t<Scale.t2; t+=Scale.t_scale_300/2){ //draw v-line
  ctx.beginPath();
  ctx.moveTo( t2x(t)+dx , 0);
  ctx.lineTo( t2x(t)+dx , H-O_y);
  ctx.stroke();
  ctx.fillText( min2hm(t), t2x(t)+dx, H-O_y/2);
}}
function update_x_axis(t1, t_scale_300){
 Scale.update(t1, t_scale_300);
 iv_list_update();
 update_graph();
}
function iv_list_update(){
 var ri, rN = Row_list.length;
 for(ri=0; ri<rN; ri++){
  var div_dose_list = Row_list[ri].div.children;
  var di, dN = div_dose_list.length;
  for(di=0; di<dN; di++){
   var div = div_dose_list[di];
   if(div.hasAttribute("time")){
    div.style.left = t2x(parseInt(div.getAttribute("time"))) + "px";
}}}}
function update_graph(){
 Canvas1CrossFix = false;
 ctx_1.clearRect(0, 0, W, H);
 ctx_2.clearRect(0, 0, W, H);
 ctx_1.fillStyle = cBG;
 ctx_1.fillRect(0, 0, W, H);
 ctx_2.fillStyle = cBG;
 ctx_2.fillRect(0, 0, W, H);
 draw_axis(ctx_1);
 draw_axis(ctx_2);
 var ai, aN = Agent_list.length;
 for(ai=0;ai<aN;ai++){
  var agentinfo = AgentInfoList[ Agent_list[ai] ];
  var showCompart = Compart.idx == ai;
  var C1e_list = simulate(agentinfo, showCompart);
  ctx_1.strokeStyle = agentinfo.color;
  ctx_1.fillStyle = agentinfo.color;
  var y1e_list = [[],[]];
  var xi,xN = Scale.x_list.length;
  for(xi=0;xi<xN;xi++){
   y1e_list[0].push( parseInt(H-O_y-C1e_list[0][xi]*1000*50/agentinfo.y_scale_50) );
   y1e_list[1].push( parseInt(H-O_y-C1e_list[1][xi]*1000*50/agentinfo.y_scale_50) );
  }
  plot_graph(ctx_1, Scale.x_list, y1e_list[0]);
  fill_graph(ctx_1, Scale.x_list, y1e_list[1]);
  var y_label =  Agent_list[ai] + ": x" + agentinfo.y_scale_50;
  ctx_1.fillText(y_label, 10, H-O_y-50 - (aN-1-ai)*15);
  if( showCompart ){
   var y2_list = [], y3_list = [];
   for(xi=0;xi<xN;xi++){
    y2_list.push( parseInt(H-O_y-Compart.C2[xi]*1000*50/agentinfo.y_scale_50) );
    y3_list.push( parseInt(H-O_y-Compart.C3[xi]*1000*50/agentinfo.y_scale_50) );
   }
   ctx_2.strokeStyle = Compart_color_list[0];
   plot_graph(ctx_2, Scale.x_list, y1e_list[0]);
   ctx_2.strokeStyle = Compart_color_list[1];
   plot_graph(ctx_2, Scale.x_list, y2_list);
   ctx_2.strokeStyle = Compart_color_list[2];
   plot_graph(ctx_2, Scale.x_list, y3_list);
}}}
function draw_axis(ctx){
 ctx.font = ctx_font;
 ctx.beginPath(); ctx.moveTo(0, H-O_y); ctx.lineTo(W, H-O_y); ctx.strokeStyle = cAX1; ctx.stroke();
 ctx.beginPath(); ctx.moveTo(O_x, 0); ctx.lineTo(O_x, H-O_y); ctx.strokeStyle = cAX1; ctx.stroke();
 ctx.fillStyle = cCH;
 ctx.fillText( "ng/mL", O_x-50, 15);
 ctx.strokeStyle = cAX2;
 var x;
 for(x=O_x; x<W; x+=150){ //draw v-line
  ctx.beginPath();
  ctx.moveTo( x, 0);
  ctx.lineTo( x, H-O_y);
  ctx.stroke();
  ctx.fillText( min2hm(x2t(x)), x, H-O_y/2);
 }
 var y;
 for(y=0; y<H-O_y; y+=50){ //draw v-line
  ctx.beginPath(); // draw h-line
  ctx.moveTo( O_x, H - O_y - y );
  ctx.lineTo( W, H - O_y - y );
  ctx.stroke();
  ctx.fillText( y/50, O_x - 15, H - O_y - y);
}}
function plot_graph(ctx, x_arr, y_arr){ // set ctx_1.strokeStyle before this
 ctx.beginPath();
 ctx.moveTo(x_arr[0], y_arr[0]);
 var i;
 for(i=1; i<x_arr.length; i++){
  ctx.lineTo(x_arr[i], y_arr[i]);
 }
 ctx.stroke();
}
function fill_graph(ctx, x_arr, y_arr){ // set ctx_1.fillStyle before this
 ctx.globalAlpha = 0.3;
 ctx.beginPath();
 ctx.moveTo(x_arr[0], H-O_y);
 var i;
 for(i=0; i<x_arr.length; i++){
  ctx.lineTo(x_arr[i], y_arr[i]);
 }
 ctx.lineTo(x_arr[x_arr.length-1], H-O_y);
 ctx.closePath();
 ctx.fill();
 ctx.globalAlpha = 1;
}
function scale_now(){
 var t1 = Date_now.getHours()*60 + Date_now.getMinutes();
 t1 = Math.floor(t1*2/Scale.t_scale_300)*Scale.t_scale_300/2;
 update_x_axis(t1, Scale.t_scale_300);
}
function scale_short(){
 var t_scale_300 =  Scale.t_scale_300/2;
 if(8<t_scale_300 && t_scale_300<16) t_scale_300 = 16;
 if(8*60<t_scale_300 && t_scale_300<16*60) t_scale_300 = 16*60;
 var t_now = Date_now.getHours()*60 + Date_now.getMinutes();
 if(Scale.t0 <= t_now && t_now <= Scale.t2){
  Scale.t_scale_300 = t_scale_300;
  scale_now();
 }
 else{
  t1 = Math.floor(Scale.t1*2/t_scale_300)*t_scale_300/2;
  update_x_axis(t1, t_scale_300);
 }
}
function scale_long(){
 if(Scale.t_scale_300 > t_MAX/4)return;
 t_scale_300 =  Scale.t_scale_300*2;
 if(30<t_scale_300 && t_scale_300<60) t_scale_300 = 30;
 if(24*60<t_scale_300 && t_scale_300<48*60) t_scale_300 = 24*60;
 t1 = Math.floor(Scale.t1*2/t_scale_300)*t_scale_300/2;
 update_x_axis(t1, t_scale_300);
}
function scale_prev(){
 if(Scale.t1 < t_MIN/2)return;
 update_x_axis(Scale.t1 - Scale.t_scale_300/2, Scale.t_scale_300);
}
function scale_next(){
 if(Scale.t1 > t_MAX/2)return;
 update_x_axis(Scale.t1 + Scale.t_scale_300/2, Scale.t_scale_300);
}

/* cursor */

function canvas_1_touchstart(e){
 e.preventDefault();
 Scale.is_moving = true;
 Scale.moving_from = e.changedTouches[0].pageX; //pageX;
}
function canvas_1_touchmove(e){
 e.preventDefault();
 if(Scale.is_moving){
  draw_moving_x_axis(ctx_1_cursor, e.changedTouches[0].pageX - Scale.moving_from);
 } else {
  var MouseRect = e.target.getBoundingClientRect();
  var x = e.clientX - MouseRect.left;
  var y = e.clientY - MouseRect.top;
  canvas1_cross( x,y, false );
}};
function canvas_1_touchend(e){
 e.preventDefault();
 if(Scale.is_moving){
  ctx_1_cursor.clearRect(0, 0, W, H);
  update_x_axis(Scale.t1 - (e.changedTouches[0].pageX - Scale.moving_from)*Scale.t_scale, Scale.t_scale_300);
  Scale.is_moving = false;
  delete(Scale.moving_from);
 } else {
  var MouseRect = e.target.getBoundingClientRect();
  var x = e.changedTouches[0].pageX - MouseRect.left;
  var y = e.changedTouches[0].pageY - MouseRect.top;
  canvas1_cross( x,y, true );
}};

var Canvas1CrossFix = false;

function canvas1_delete(){
 ctx_1_cursor.clearRect(0, 0, W, H);
 ctx_2_cursor.clearRect(0, 0, W, H);
 Canvas1CrossFix = false;
}
function canvas1_cross( x,y,b ){
 if(Canvas1CrossFix){ return; }
 if (x<0 || x>W || y<0 || y>H){ canvas1_delete(); return;}
 Canvas1CrossFix = b;
 ctx_1_cursor.lineWidth = 1;
 ctx_1_cursor.strokeStyle = "red";
 ctx_1_cursor.fillStyle = "red";
 ctx_1_cursor.font = ctx_font;
 ctx_2_cursor.lineWidth = 1;
 ctx_2_cursor.strokeStyle = "red";
 ctx_1_cursor.clearRect(0, 0, W, H);
 ctx_1_cursor.beginPath(); ctx_1_cursor.moveTo(x, 0); ctx_1_cursor.lineTo(x, H); ctx_1_cursor.stroke();
 ctx_1_cursor.beginPath(); ctx_1_cursor.moveTo(0, y); ctx_1_cursor.lineTo(canvas_1_cursor.width, y); ctx_1_cursor.stroke();
 ctx_1_cursor.fillText( min2hm(x2t(x)), x+1, H-O_y);
 ctx_1_cursor.fillText( myPrecision((H-O_y-y)/50), O_x-15, y-1);
 ctx_2_cursor.clearRect(0, 0, W, H);
 ctx_2_cursor.beginPath(); ctx_2_cursor.moveTo(x, 0); ctx_2_cursor.lineTo(x, H); ctx_2_cursor.stroke();
 disp_compart_info(x);
}

/* row_display */

var Touching_n = -1;

function dosearea_touchstart(e){
 e.preventDefault();
 Touching_n = parseInt(e.target.parentElement.getAttribute("n"));
 if(Row_list[Touching_n]){ setClass(Row_list[Touching_n].div.firstChild, "drug_row_hover"); }
 else{ Touching_n = -1; }
}

function dosearea_touchmove(e){
 e.preventDefault();
 var containerRect = d("drug_row_container").getBoundingClientRect();
 var x = e.changedTouches[0].pageX - containerRect.left;
 var y = e.changedTouches[0].pageY - containerRect.top;
 var new_n = Math.floor(y/row_H);
 if( new_n != Touching_n ){
  if(Touching_n != -1){ setClass(Row_list[Touching_n].div.firstChild, "drug_row"); }
  if(Row_list[new_n]){
   Touching_n = new_n;
   setClass(Row_list[Touching_n].div.firstChild, "drug_row_hover");
  }
  else{ Touching_n = -1; }
 }
 cursor_to( e.changedTouches[0].pageX - containerRect.left );
}
function dosearea_touchend(e){
 e.preventDefault();
 var n = Touching_n;
 if(Row_list[Touching_n]){
  setClass(Row_list[Touching_n].div.firstChild, "drug_row");
  var containerRect = d("drug_row_container").getBoundingClientRect();
  var x = e.changedTouches[0].pageX - containerRect.left;
  var time =  x2t(x);
  add_drug(Touching_n,time);
  Touching_n = -1;
 }
}
function cursor_move_on_dose(div){
 cursor_to( t2x( parseInt(div.getAttribute("time") )) );
}
function cursor_to(x){
 Canvas1CrossFix = false;
 ctx_1_cursor.lineWidth = 1;
 ctx_1_cursor.strokeStyle = "red";
 ctx_1_cursor.fillStyle = "red";
 ctx_1_cursor.font = ctx_font;
 ctx_1_cursor.clearRect(0, 0, W, H);
 ctx_1_cursor.beginPath(); ctx_1_cursor.moveTo(x, 0); ctx_1_cursor.lineTo(x, H); ctx_1_cursor.stroke();
 ctx_1_cursor.fillText( min2hm(x2t(x)), x+1, H);
 ctx_2_cursor.lineWidth = 1;
 ctx_2_cursor.strokeStyle = "red";
 ctx_2_cursor.clearRect(0, 0, W, H);
 ctx_2_cursor.beginPath(); ctx_2_cursor.moveTo(x, 0); ctx_2_cursor.lineTo(x, H); ctx_2_cursor.stroke();
 disp_compart_info(x);
}
function cursor_delete() {
 Canvas1CrossFix = false;
 ctx_1_cursor.clearRect(0, 0, W, H);
 ctx_2_cursor.clearRect(0, 0, W, H);
}

function create_new_drug_row(){
 var n = Row_list.length;
 var DIV_row = document.createElement('div');
 var DIV_labelarea = document.createElement('div');
 var DIV_dosearea = document.createElement('div');
 document.getElementById("drug_row_container").appendChild(DIV_row);
 DIV_row.appendChild(DIV_dosearea);
 DIV_row.appendChild(DIV_labelarea);
 var row = new Row(DIV_row);
 DIV_row.style.position = "absolute";
 DIV_row.style.top = n*row_H + "px";
 DIV_row.setAttribute("n", n);
 DIV_labelarea.style.minWidth = O_x + "px";
 DIV_labelarea.style.height = row_H + "px";
 DIV_labelarea.style.position = "absolute";
 DIV_labelarea.style.whiteSpace = "nowrap";
 DIV_labelarea.style.borderColor = "black";
 DIV_dosearea.style.minWidth = W + "px";
 DIV_dosearea.style.height = row_H + "px";
 DIV_dosearea.style.position = "absolute";
 setClass(DIV_labelarea, "drug_row");
 setClass(DIV_dosearea, "drug_row");
 DIV_labelarea.onclick = function(e){
  var n = parseInt(e.target.parentElement.getAttribute("n"));
  var date = new Date();
  var time = date.getHours()*60 + date.getMinutes();
  add_drug(n,time);
 };
 DIV_labelarea.onmousemove = function(){
  var Date_now = new Date();
  var h = Date_now.getHours();
  var m = Date_now.getMinutes();
  cursor_to( t2x( h*60+m ) );
 }
 DIV_labelarea.onmouseout = cursor_delete;
 DIV_dosearea.onclick = function(e){
  var MouseRect = e.target.getBoundingClientRect();
  var x = e.clientX - MouseRect.left;
  var n = parseInt(e.target.parentElement.getAttribute("n"));
  var time =  x2t(x);
  add_drug(n,time);
 }
 DIV_dosearea.onmousemove = function(e){
  var MouseRect = e.target.getBoundingClientRect();
  cursor_to( e.clientX - MouseRect.left );
 }
 DIV_dosearea.onmouseout = cursor_delete;
 if(DIV_labelarea.addEventListener) {
  DIV_dosearea.addEventListener('touchstart', dosearea_touchstart, false);
  DIV_dosearea.addEventListener('touchmove', dosearea_touchmove, false);
  DIV_dosearea.addEventListener('touchend', dosearea_touchend, false);
 }
 else if(DIV_labelarea.attachEvent) { 
  DIV_dosearea.attachEvent('touchstart', dosearea_touchstart, false);
  DIV_dosearea.attachEvent('touchmove', dosearea_touchmove, false);
  DIV_dosearea.attachEvent('touchend', dosearea_touchend, false);
 }
 adjust_height();
}
function adjust_height(){
 document.getElementById('area1').style.height = (H + row_H * Row_list.length) + "px";
}

/* dose entry */

var Setting = {
 is_pop_up: false,
 new_agent: "",
 row: null,
 new_row: null,
 agentinfo: null,
 edit_div: null,
 active_drug_button_div: null,
 active_unit_button_div: null,
 active_model_button_div: null,
 input_selected: false,
 initialize: function(row){
  this.is_pop_up= true;
  this.new_agent= "";
  this.row= row;
  this.new_row = {
   agent: row.agent,
   unit: row.unit,
   model_at: {}
  };
  this.edit_div= null;
  this.active_drug_button_div= null;
  this.active_unit_button_div= null;
  this.active_model_button_div= null;
  this.input_selected= false;
  this.manual_model= false;
  this.agentinfo = {};
 },
}
function drug_list_ready(){
 var div = document.getElementById("PU_1_agent_list");
 while (div.firstChild) { div.removeChild(div.lastChild); }
// delete childnodes in case user has downloaded loaded HTML 
 var agent;
 for(agent in AgentInfoList){  
  var div_drug = document.createElement('div');
  var span1 = document.createElement('span');
  var span2 = document.createElement('span');
  div_drug.innerHTML = AgentInfoList[agent].agent_fullname;
  span1.innerHTML = AgentInfoList[agent].bolus_unit;//"Bolus";
  span2.innerHTML = AgentInfoList[agent].infusion_unit;//"Infusion";
  setClass(span1, "button_wide");
  setClass(span2, "button_wide");
  span1.setAttribute("agent", agent);
  span2.setAttribute("agent", agent);
  span1.setAttribute("onclick", "select_drug(this);");
  span2.setAttribute("onclick", "select_drug(this);");
  div.appendChild(div_drug);
  div.appendChild(span1);
  div.appendChild(span2);
 }
}

function add_drug(n, time){
 if(Setting.is_pop_up){return;}
 Setting.initialize(Row_list[n]);
 edit_mode(false);
 appear("PU_1_rowinfo");
 if(Setting.row.agent){
  appear("delete_row_button");
  Row_list[n].PU_1_div.innerHTML = Row_list[n].unit;
  select_drug(Row_list[n].PU_1_div);
  setClass(document.getElementById("dose_prev_button"), Setting.row.entry_list.length>0? "button": "button_invalid" );
 }
 else{
  disappear("delete_row_button");
  setClass(document.getElementById("dose_prev_button"), "button_invalid");
 }
 setClass(document.getElementById("dose_next_button"), "button_invalid");
 document.getElementById("entry_time").value = min2hm(time);
 manual_param_to(false);
}
function edit_drug(div){
 if(Setting.is_pop_up){return;}
 var n = parseInt(div.parentElement.getAttribute("n"));
 var row = Row_list[n];
 Setting.initialize(row);
 Setting.edit_div = div;
 row.PU_1_div.innerHTML = row.unit;
 select_drug(row.PU_1_div, row.agent);
 edit_mode(true);
 appear("PU_1_rowinfo");
 appear("delete_row_button");
 setClass(document.getElementById("dose_prev_button"), div.previousSibling.hasAttribute("time")? "button":"button_invalid");
 setClass(document.getElementById("dose_next_button"), div.nextSibling.hasAttribute("time")? "button":"button_invalid");
 var time = parseInt(div.getAttribute("time"));
 document.getElementById("entry_time").value = min2hm(time);
 document.getElementById("dose").value = Setting.dose_selected = Setting.row.iv_dose_at[time];
 if(Setting.dose_selected === undefined){ document.getElementById("dose").value = ""; }
 manual_param_to(row.model_at[time]? true: false);
 setTimeout('document.getElementById("dose").select();',10);
 Setting.input_selected = true;
}

function select_drug(button_div){
 if(Setting.active_drug_button_div){ setClass(Setting.active_drug_button_div, "button_wide");}
 setClass(button_div, "button_wide_selected");
 Setting.active_drug_button_div = button_div
 var agent = button_div === Setting.row.PU_1_div? Setting.row.agent: button_div.getAttribute("agent");
 var unit = button_div.innerHTML;
 document.getElementById("PU_3_agent").value = agent;
 Setting.new_row.agent = agent;
 Setting.new_row.unit = unit;
 Setting.agentinfo = {}
 var key; for(key in AgentInfoList[agent]){
  Setting.agentinfo[key] = AgentInfoList[agent][key];
 }
 appear("PU_2_entry");
 appear("PU_3_agentinfo");
 document.getElementById("PU_3_color").value = Setting.agentinfo.color;
 document.getElementById("PU_3_scale").value = Setting.agentinfo.y_scale_50;
 document.getElementById("PU_3_mgmL").value = Setting.agentinfo.mgmL;
/* unit */
 var is_infusion = UnitInfoList[unit].is_infusion;
 var unit_on = is_infusion? "select_infusion_unit": "select_bolus_unit";
 var unit_off = is_infusion? "select_bolus_unit" : "select_infusion_unit";
 appear(unit_on);
 disappear(unit_off);
 var j,unit_divlist = document.getElementById(unit_on).children;
 for(j=0; j<unit_divlist.length; j++){
  if(unit_divlist[j].children[1].innerHTML == unit){
   PU_change_unit(unit_divlist[j].children[1],false); break;
  }
 }
 PU_change_val(null);
/* model */
 if(!Setting.agentinfo.active_model_g)Setting.agentinfo.active_model_g = Setting.agentinfo.model_list[0].model_g;
 model_ready(document.getElementById("preset_model"), Setting.agentinfo.model_list, "preset");
 model_ready(document.getElementById("TCI_model"), Setting.agentinfo.model_list, "TCI");
 document.getElementById("dose").focus();
}
function model_ready(div, model_list, mode){
 while(div.firstChild) { div.removeChild(div.lastChild); }
 var i,button_div = null;
 if(mode=="TCI"){
  var divchild = document.createElement("div");
  divchild.innerHTML = "TCI model:"
  div.appendChild(divchild);
 }
 for(i=0; i<model_list.length; i++){
  var divchild = document.createElement("div");
  divchild.innerHTML = model_list[i].label;
  divchild.setAttribute("onclick","PU_model_click(this);")
  divchild.setAttribute("i",i);
  divchild.setAttribute("mode",mode);
  setClass(divchild, "button_wide");
  div.appendChild(divchild);
  if(Setting.agentinfo.active_model_g === Setting.agentinfo.model_list[i].model_g){
   button_div = divchild; 
   PU_model_click(button_div);
}}}

function edit_mode(b){
 document.getElementById("pop_up_mode").innerHTML = b?"Edit mode":"Add mode";
 setClass(document.getElementById("pop_up_mode"), b?"mild_label_2":"mild_label");
 if(b){ appear("delete_entry_button"); }
 else{ disappear("delete_entry_button"); }
}
function change_label(input){
 Setting.new_agent = input.value;
 if(AgentInfoList[input.value]){
  document.getElementById("PU_3_color").value = Setting.agentinfo.color = AgentInfoList[input.value].color;
  document.getElementById("PU_3_scale").value = Setting.agentinfo.y_scale_50 = AgentInfoList[input.value].y_scale_50;
 } else {
  document.getElementById("PU_3_color").value = Setting.agentinfo.color = "#000000";
}}
function change_y_scale(input){
 var val = parseFloat(input.value);
 if(isNaN(val))return;
 Setting.agentinfo.y_scale_50 = val;
}
function change_mgmL(input){
 var val = parseFloat(input.value);
 if(isNaN(val))return;
 Setting.agentinfo.mgmL = val;
 input = Setting.active_unit_button_div.parentElement.children[0];
 PU_change_val(input);
}
function PU_change_val(input){
 if(!input){
  input = Setting.active_unit_button_div.parentElement.children[0];
  if(!input) return;
  input.value = document.getElementById("dose").value;
 }
 var val = parseFloat(input.value) 
 if(isNaN(val))return;
 var unit = input.parentElement.children[1].innerHTML;
// if(unit.indexOf("g/mL")!=-1)return;
 var j,div_list = input.parentElement.parentElement.children;
 var mgmL = Setting.agentinfo.mgmL;
 var mg = val * UnitInfoList[unit].calc_mg_per_val(Current_patient.TBW, mgmL);
 for(j=0;j<div_list.length;j++){
  var input_j = div_list[j].children[0];
  if(input_j !== input){
   var unit_j = div_list[j].children[1].innerHTML;
   if((unit_j.indexOf("g/mL")!=-1) != (unit.indexOf("g/mL")!=-1))continue;
   var new_val = mg / UnitInfoList[unit_j].calc_mg_per_val(Current_patient.TBW, mgmL);
   input_j.value = myPrecision(new_val);
  } else {
   document.getElementById("dose").value = input_j.value;
  }
}}
function PU_change_unit(button_div, is_new_val){
 var button_div = button_div.parentElement.children[1];
 var unit = button_div.innerHTML;
 if(Setting.active_unit_button_div){ setClass(Setting.active_unit_button_div, "button_wide");}
 setClass(button_div, "button_wide_selected");
 Setting.active_unit_button_div = button_div;
 Setting.new_row.unit = unit;
 document.getElementById("dose_unit").innerHTML = unit;
 Setting.active_drug_button_div.innerHTML = unit;
 checkTCI(unit.indexOf("g/mL")!=-1);
 if(is_new_val){
  if(button_div.parentElement.children[0].value){
   document.getElementById("dose").value = button_div.parentElement.children[0].value;
  }
  document.getElementById("dose").focus();
 }
}
function checkTCI(is_TCI){
 if(is_TCI){
  appear("TCI_model");
  var label = document.getElementById("PU_3_agent").value;
  if(label.substring(label.length-4)!="_TCI"){
   document.getElementById("PU_3_agent").value = label+"_TCI";
  }
 }
 else{
  disappear("TCI_model");
  var label = document.getElementById("PU_3_agent").value;
  if(label.substring(label.length-4)=="_TCI"){
   document.getElementById("PU_3_agent").value = label.substring(0,label.length-4);
  }
 }
}

function PU_model_click(button_div){
 var mode = button_div.getAttribute("mode");
 if(mode == "preset"){
  Setting.agentinfo.active_model_g = Setting.agentinfo.model_list[parseInt(button_div.getAttribute("i"))].model_g;
  if(Setting.active_model_button_div){ setClass(Setting.active_model_button_div, "button_wide");}
  setClass(button_div, "button_wide_selected");
  Setting.active_model_button_div = button_div;
  if(Setting.new_row.model_at[t_MAX]){assign_param(Setting.new_row.model_at[t_MAX]);}
 }
 else if(mode == "TCI"){
  Setting.agentinfo.TCI_model_g = Setting.agentinfo.model_list[parseInt(button_div.getAttribute("i"))].model_g;
  if(Setting.TCI_model_button_div){ setClass(Setting.TCI_model_button_div, "button_wide");}
  setClass(button_div, "button_wide_selected");
  Setting.TCI_model_button_div = button_div;
 }
}
function dose_input(x){
 if(Setting.input_selected){
  if(document.getElementById("dose").value == Setting.dose_selected){ // if there was no keyboard input
   document.getElementById("dose").value = "";
  }
  Setting.input_selected = false;
 }
 if(x=="." && document.getElementById("dose").value.indexOf(".")!=-1){ return; }
 if(x=="clear"){ document.getElementById("dose").value = ""; }
 else if(x=="BS"){ document.getElementById("dose").value = document.getElementById("dose").value.slice( 0, -1 ); }
 else {document.getElementById("dose").value = document.getElementById("dose").value + x;}
 document.getElementById("dose").focus();
 PU_change_val(null);
}
function entry_time_c(dt){
 var time =  hm2min(document.getElementById("entry_time").value) + parseInt(dt);
 document.getElementById("pop_up_overwriting").style.display = (Setting.new_row.iv_dose_at && Setting.new_row.iv_dose_at[time] && time!=Setting.edit_div.getAttribute("time") ) ? "inline" : "none";
 document.getElementById("entry_time").value = min2hm(time);
}
function dose_done(){
 if(!Setting.is_pop_up){return;} //prevent double action by onkeydown and onsubmit
 var old_agent = Setting.row.agent;
 var is_TCI = Setting.new_row.unit.indexOf("g/mL")!=-1;
 checkTCI(is_TCI);
 Setting.new_row.agent = document.getElementById("PU_3_agent").value;
 Setting.agentinfo.color = document.getElementById("PU_3_color").value;
 var val = parseFloat(document.getElementById("PU_3_scale").value);
 if(!isNaN(val)) { Setting.agentinfo.y_scale_50 = val; }
/* new_register */
 if(Setting.row.agent==""){
  Setting.row.agent = Setting.new_agent? Setting.new_agent: Setting.new_row.agent;
  Setting.row.PU_1_div = Setting.active_drug_button_div;
  if( Setting.new_agent){
   Setting.row.PU_1_div.setAttribute("agent", Setting.new_agent)
  }
  if(!AgentInfoList[Setting.row.agent]){
   AgentInfoList[Setting.row.agent] = copyAgentInfo(Setting.agentinfo)
  }
  AgentInfoList[Setting.row.agent].add_row(Setting.row); //  Setting.row.div.lastChild.style.borderColor = "black";
  create_new_drug_row();
 }
 else{
/* change agent */
  if(Setting.row.PU_1_div != Setting.new_row.PU_1_div){
   AgentInfoList[Setting.row.agent].delete_row(Setting.row);
   Setting.row.agent = Setting.new_row.agent;
   Setting.row.PU_1_div = Setting.active_drug_button_div;
   if(!AgentInfoList[Setting.row.agent]){
    AgentInfoList[Setting.row.agent] = copyAgentInfo(Setting.agentinfo)
   }
   AgentInfoList[Setting.row.agent].add_row(Setting.row);
  }
/* change label and register agentinfo */
  if(Setting.new_agent && Setting.new_agent != Setting.row.agent){
   AgentInfoList[Setting.row.agent].delete_row(Setting.row);
   Setting.row.agent = Setting.new_agent;
   if(!AgentInfoList[Setting.new_agent]){
    AgentInfoList[Setting.new_agent] = copyAgentInfo(Setting.agentinfo)
   }
   AgentInfoList[Setting.row.agent].add_row(Setting.row);
   Setting.row.PU_1_div.setAttribute("agent", Setting.new_agent)
  }
 }
/* update agentinfo */
 AgentInfoList[Setting.row.agent].color = Setting.agentinfo.color;
 AgentInfoList[Setting.row.agent].y_scale_50 = Setting.agentinfo.y_scale_50;
 AgentInfoList[Setting.row.agent].active_model_g = Setting.agentinfo.active_model_g;
 if(is_TCI) AgentInfoList[Setting.row.agent].TCI_model_g = Setting.agentinfo.TCI_model_g;

/* unit */
 if( Setting.row.unit != Setting.new_row.unit || Setting.new_row.unit.indexOf("mL")!=-1 && AgentInfoList[old_agent].mgmL != Setting.agentinfo.mgmL ){
  Setting.row.unit = Setting.new_row.unit;
  Setting.row.update_value( Setting.row.unit, Setting.agentinfo.mgmL);
 }
/* agentinfo */
 Setting.row.div.lastChild.innerHTML = Setting.row.agent + "("+Setting.row.unit+")"; 
 Setting.row.div.lastChild.style.color = AgentInfoList[Setting.row.agent].color;
/* entry */
 var time = hm2min( document.getElementById("entry_time").value  );
 var dose = parseFloat(document.getElementById("dose").value);
 var DIV = Setting.edit_div;
 if(DIV && !isNaN(dose)){ // change data
  Setting.row.delete_data(parseInt(Setting.edit_div.getAttribute("time")));
 }
 if(!DIV){
  DIV = document.createElement('div');
  setClass(DIV, "dose_each");
  DIV.setAttribute("onclick","edit_drug(this);" )
  DIV.setAttribute("onmouseover","cursor_move_on_dose(this);" );
  DIV.style.position = "absolute";
 }
 var model = null;
 if(Setting.new_row.model_at[t_MAX]){
  var div = document.getElementById("PU_manual_model");
  var i;
  var parameters = [];
  for(i=0;i<7;i++){ parameters.push( parseFloat(div.children[i].children[0].value) ); }
  model = model_from_VQ(parameters[0],parameters[1],parameters[2],parameters[3],parameters[4],parameters[5],parameters[6]);
 }
 if( Setting.new_row.model_at[t_MAX] || !isNaN(dose)){
  var dose_disp = dose;
  if( !isNaN(dose) && dose<1 && dose_disp.length > 3){ dose_disp = dose.toPrecision(1);}
  var idx = Setting.row.add_data(time,(isNaN(dose)?null:dose),model);
  Setting.row.div.insertBefore(DIV, Setting.row.div.children[1+idx] || null);
  DIV.innerHTML = ( UnitInfoList[Setting.row.unit].is_infusion && dose==0? "/":
   (isNaN(dose)?"":dose_disp) + (UnitInfoList[Setting.row.unit].is_infusion && dose?"-":"")
   ) + (Setting.new_row.model_at[t_MAX]?"#":"");
  DIV.setAttribute("time", time);
  DIV.style.left = parseInt( t2x(time) ) + "px";
 }
 dose_close();
 update_graph();
}
function dose_close(){
 if(Setting.active_drug_button_div){
  setClass(Setting.active_drug_button_div, "button_wide");
 }
 if(Setting.active_unit_button_div){
  setClass(Setting.active_unit_button_div, "button_wide");
 }
 document.getElementById("dose").value = "";
 var j,unit_divlist = document.getElementById("select_bolus_unit").children;
 for(j=0; j<unit_divlist.length; j++){ unit_divlist[j].children[0].value = ""; }
 unit_divlist = document.getElementById("select_infusion_unit").children;
 for(j=0; j<unit_divlist.length; j++){ unit_divlist[j].children[0].value = ""; }
 disappear("PU_1_rowinfo");
 disappear("PU_2_entry");
 disappear("PU_3_agentinfo");
 document.getElementById("pop_up_overwriting").style.display = "none";
 Setting.is_pop_up = false;
}
function dose_delete(){
 Setting.row.delete_data(parseInt(Setting.edit_div.getAttribute("time")));
 Setting.edit_div.parentElement.removeChild(Setting.edit_div);
 dose_close();
 update_graph();
}
function dose_prev(){
 if(document.getElementById("dose_prev_button").className == "button_invalid")return;
 document.getElementById("pop_up_overwriting").style.display = "none";
 var div = Setting.edit_div;
 if(div){
  Setting.is_pop_up = false;
  edit_drug( div.previousSibling );
 }
 else{
  var child_list = Setting.row.div.childNodes;
  Setting.is_pop_up = false;
  edit_drug( child_list[child_list.length-2] );
}}
function dose_next(){
 if(document.getElementById("dose_next_button").className == "button_invalid")return;
 document.getElementById("pop_up_overwriting").style.display = "none";
 Setting.is_pop_up = false;
 edit_drug( Setting.edit_div.nextSibling );
}
function drug_delete(){
 var n = Setting.row.n;
 if(!confirm("Are you sure to delete all data in this row " + Setting.row.agent+"("+ Setting.row.unit + ")?"))return;
 var div_list = document.getElementById("drug_row_container").children;
 var i;
 for(i=div_list.length-1;i>n;i--){
  div_list[i].setAttribute("n", i-1);
  div_list[i].style.top = (i-1)*row_H + "px";
 }
 Setting.row.delete();
 document.getElementById("drug_row_container").removeChild(div_list[n])
 dose_close();
 adjust_height();
 update_graph();
}

function no_zoom(){
// Disable double-tap "zoom" in touch devices
// https://stackoverflow.com/questions/10614481/disable-double-tap-zoom-option-in-browser-on-touch-devices
 var fi,formlist = document.forms;
 for(fi=0; fi<formlist.length; fi++){
  var form = formlist[fi];
  if(form.addEventListener){
   form.addEventListener("touchend",function(e){e.preventDefault();});
   var ci, childlist = form.children;
   for(ci=0;ci<childlist.length;ci++){ 
    var child = childlist[ci];
    if(child.className=="button"){child.addEventListener("touchend",function(e){e.preventDefault();e.target.click();});}
    else{child.addEventListener("touchend",function(e){e.preventDefault();e.target.focus();});}
}}}}

/* manual model edit */

var param_list = ["V1","V2","V3","CL","Q2","Q3","ke"]

function manual_param_to(b){
 setClass( document.getElementById("entry_manual"), b? "button_wide_selected": "button_wide")
 setClass( document.getElementById("entry_preset"), b? "button_wide": "button_wide_selected")
 if(!b){ disappear("PU_manual_model");return; }
 appear("PU_manual_model");
 var model;
 var ti,t_prev = hm2min(document.getElementById("entry_time").value)
 var t_list = Setting.row.entry_list;
 for(ti=t_list.length-1;ti>=0;ti--){
  if(t_list[ti] > t_prev)continue;
  model = Setting.row.model_at[t_list[ti]];
  if(model)break;
 }
 if(!model){ model = Setting.agentinfo.active_model_g(Current_patient); }
 Setting.new_row.model_at[t_MAX] = model;
 assign_param(model);
}
function assign_param(model){
 var div = document.getElementById("PU_manual_model");
 var i;
 for(i=0;i<param_list.length;i++){
  var div_i = div.children[i];
  div_i.children[0].value = model[param_list[i]];
  setClass(div_i.children[1], model[param_list[i]] == Setting.agentinfo.active_model_g(Current_patient)[param_list[i]]? "button_wide_selected": "button_wide");
 }
}
function manual_param(div, b){
 if( div.className == "button_wide_selected") return;
 setClass(div.parentElement.children[1], b? "button_wide": "button_wide_selected");
 if(!b){
  var i = parseInt(div.parentElement.getAttribute("i"));
  div.parentElement.children[0].value = Setting.agentinfo.active_model_g(Current_patient)[param_list[i]]
 }
}

/* compartment visualization */

var Compart = {
 O_y_top: 15,
 idx: -1,
 agent: "",
 C1:[], C2:[], C3:[], infusion_rate:[], model:[],
 TCI_infusion:[], TCI_total:[]
}
function compart_ready(){
 document.getElementById("drug_row_container").style.top = H + "px";
 document.getElementById("area2").style.height = (H+CompLineWidth) + "px";
 document.getElementById("comp_2").style.height = H-O_y-Compart.O_y_top + "px"
 document.getElementById("comp_1").style.height = H-O_y-Compart.O_y_top + "px";
 document.getElementById("comp_3").style.height = H-O_y-Compart.O_y_top + "px";
 document.getElementById("compline_10").style.top = H-O_y + "px";
 document.getElementById("compline_12").style.width = CompLineWidth + "px";
 document.getElementById("compline_13").style.width = CompLineWidth + "px";
 document.getElementById("compline_10").style.height = CompLineWidth + "px";
 document.getElementById("compline_info_10").style.top = H + "px";
 document.getElementById("compline_info_10").style.width = CompLineWidth + "px";
 document.getElementById("compline_info_in").style.top = "-15px";
 document.getElementById("compline_info_in").style.width = CompLineWidth + "px";
 document.getElementById("comp_out").style.top = H-O_y + CompLineWidth + "px";
 document.getElementById("comp_out").style.width = CompLineWidth + "px";
 var div = document.getElementById("compart_agent");
 while (div.firstChild) { div.removeChild(div.lastChild); }
}
function create_CA_div(idx){
 var div = document.createElement("div");
 div.innerHTML = Agent_list[idx];
 div.style.minWidth = "50px"
 setClass(div, "button_wide");
 div.setAttribute("onclick", "set_compart(this);update_graph();");
 div.setAttribute("idx", idx);
 document.getElementById("compart_agent").appendChild(div);
 if(idx==0)set_compart(div);
}
function delete_CA_div(idx){
 var CA_div = document.getElementById("compart_agent");
 CA_div.removeChild(CA_div.children[idx]);
 var ai;
 for(ai=idx; ai<CA_div.childNodes.length; ai++){
  CA_div.childNodes[ai].setAttribute("idx",ai);
 }
 if(Compart.idx >= idx) Compart.idx--;
 set_compart( CA_div.childNodes[Compart.idx] );
}
function set_compart(div){
 if(!div)return;
 if( Compart.idx != -1) setClass(div.parentElement.childNodes[Compart.idx], "button_wide"); // unselect old one
 setClass(div, "button_wide_selected");
 Compart.idx = parseInt(div.getAttribute("idx"));
}
function disp_compart(model){
 var L2 = Math.sqrt(model.V2)*30;
 var L1 = Math.sqrt(model.V1)*30;
 var L3 = Math.sqrt(model.V3)*30;
 var L12 = model.Q2*20;
 var L13 = model.Q3*20;
 var L10 = model.CL*20;
 document.getElementById("comp_2").style.width = L2 + "px"
 document.getElementById("comp_1").style.width = L1 + "px";
 document.getElementById("comp_3").style.width = L3 + "px";
 document.getElementById("comp_inner_2").style.width = L2 + "px"
 document.getElementById("comp_inner_1").style.width = L1 + "px";
 document.getElementById("comp_inner_3").style.width = L3 + "px";
 document.getElementById("comp_info_2").innerHTML = model.V2.toFixed(2) + "L"
 document.getElementById("comp_info_1").innerHTML = model.V1.toFixed(2) + "L"
 document.getElementById("comp_info_3").innerHTML = model.V3.toFixed(2) + "L"
 document.getElementById("comp_info_2").width = L2 + CompLineWidth + "px";
 document.getElementById("comp_info_1").width = L1 + CompLineWidth + "px";
 document.getElementById("comp_info_3").width = L3 + CompLineWidth + "px";
 document.getElementById("compline_12").style.height = L12 + "px";
 document.getElementById("compline_13").style.height = L13 + "px";
 document.getElementById("compline_10").style.width = L10 + "px";
 document.getElementById("compline_12").style.top = H-O_y-L12 + "px";
 document.getElementById("compline_13").style.top = H-O_y-L13 + "px";
 var m_left = O_x;
 document.getElementById("comp_2").style.left = m_left + "px";
 document.getElementById("comp_1").style.left = m_left + L2 + CompLineWidth + "px";
 document.getElementById("comp_3").style.left = m_left + L2 + CompLineWidth + L1 + CompLineWidth + "px";
 document.getElementById("comp_info_2").style.left = m_left + "px";
 document.getElementById("comp_info_1").style.left = m_left + L2 + CompLineWidth + "px";
 document.getElementById("comp_info_3").style.left = m_left + L2 + CompLineWidth + L1 + CompLineWidth + "px";
 document.getElementById("comp_out").style.left = m_left + L2 + CompLineWidth + L1/2 - L10/2 + "px";
 document.getElementById("compline_12").style.left = m_left + L2 + "px";
 document.getElementById("compline_13").style.left = m_left + L2 + CompLineWidth + L1 + "px";
 document.getElementById("compline_10").style.left = m_left + L2 + CompLineWidth + L1/2 - L10/2 + "px";
 document.getElementById("compline_info_12").style.left = m_left + L2 + "px";
 document.getElementById("compline_info_13").style.left = m_left + L2 + CompLineWidth + L1 + "px";
 document.getElementById("compline_info_10").style.left = m_left + L2 + CompLineWidth + L1/2 - L10/2 + "px";
 document.getElementById("compline_info_in").style.left = m_left + L2 + CompLineWidth + L1/2 - L10/2 + "px";
}
function hide_compart(){
 document.getElementById("comp_2").style.left = "-999px";
 document.getElementById("comp_1").style.left = "-999px";
 document.getElementById("comp_3").style.left = "-999px";
 document.getElementById("comp_info_2").style.left = "-999px";
 document.getElementById("comp_info_1").style.left = "-999px";
 document.getElementById("comp_info_3").style.left = "-999px";
 document.getElementById("comp_out").style.left = "-999px";
 document.getElementById("compline_12").style.left = "-999px";
 document.getElementById("compline_13").style.left = "-999px";
 document.getElementById("compline_10").style.left = "-999px";
 document.getElementById("compline_info_12").style.left = "-999px";
 document.getElementById("compline_info_13").style.left = "-999px";
 document.getElementById("compline_info_10").style.left = "-999px";
 document.getElementById("compline_info_in").style.left = "-999px";
}
function disp_compart_info(x0){
 if(Compart.idx==-1) return;
 var x = Math.floor(x0/Scale.dx);
 if(x<0 || x>=Scale.x_list.length) return;
 var model = Compart.model[x];
 if(!model){ hide_compart();return;}
 disp_compart(model);
 var agent = Agent_list[Compart.idx];
 var unit = AgentInfoList[agent].y_scale_50>10? "mg": "mcg"; // this is arbitrary
 var c = unit=="mcg"?1000:1;
 var C1h = Compart.C1[x]*1000*50/AgentInfoList[agent].y_scale_50;
 var C2h = Compart.C2[x]*1000*50/AgentInfoList[agent].y_scale_50;
 var C3h = Compart.C3[x]*1000*50/AgentInfoList[agent].y_scale_50;
 document.getElementById("comp_inner_1").style.height = C1h + "px";
 document.getElementById("comp_inner_2").style.height = C2h + "px";
 document.getElementById("comp_inner_3").style.height = C3h + "px";
 document.getElementById("comp_inner_1").style.top = H-O_y-Compart.O_y_top-C1h + "px";
 document.getElementById("comp_inner_2").style.top = H-O_y-Compart.O_y_top-C2h + "px";
 document.getElementById("comp_inner_3").style.top = H-O_y-Compart.O_y_top-C3h + "px";
 var flow12 = model.Q2 * (Compart.C1[x] - Compart.C2[x]) * 60 * c;
 var flow13 = model.Q3 * (Compart.C1[x] - Compart.C3[x]) * 60 * c;
 var flow10 = model.CL * Compart.C1[x] * 60 * c;
 var dA1;
 if(AgentInfoList[Agent_list[Compart.idx]].TCI_model_g){
  dA1 = Compart.TCI_infusion[x] * c - flow12 - flow13 - flow10;
  document.getElementById("compline_info_in").innerHTML = "↓" + myPrecision(Compart.TCI_infusion[x]*c) + unit + "/h (Total " + myPrecision(Compart.TCI_total[x]*c) +  unit + ")";
 } else {
  dA1 = Compart.infusion_rate[x] * 60 * c - flow12 - flow13 - flow10;
  document.getElementById("compline_info_in").innerHTML = Compart.infusion_rate[x]!=0?"↓" + myPrecision(Compart.infusion_rate[x]*60*c) + unit + "/h":"";
 }
 document.getElementById("comp_info_1").innerHTML = (Compart.C1[x]*model.V1*c).toPrecision(3) + unit + "/" + model.V1.toPrecision(3) + "L"
  + "<br><br><br>" + myPrecision_signed(dA1) + unit + "/h";
 document.getElementById("comp_info_2").innerHTML = (Compart.C2[x]*model.V2*c).toPrecision(3) + unit + "/" + model.V2.toPrecision(3) + "L";
 document.getElementById("comp_info_3").innerHTML = (Compart.C3[x]*model.V3*c).toPrecision(3) + unit + "/" + model.V3.toPrecision(3) + "L";
 document.getElementById("compline_info_12").innerHTML =  (flow12>=0?"←"+myPrecision(flow12):"→"+myPrecision(-flow12)) + unit + "/h";
 document.getElementById("compline_info_13").innerHTML =  (flow13>=0?"→"+myPrecision(flow13):"←"+myPrecision(-flow13)) + unit + "/h";
 document.getElementById("compline_info_10").innerHTML = "↓" + myPrecision(flow10) + unit + "/h";
}
</script>
<style>
body{
 -ms-touch-action: manipulation;
 touch-action: manipulation;
}

canvas{ position:absolute;}
input{
 border: solid 2px #666666;
 background-color: #eeeeee;
 margin:5px;
 width: 50px;
}
#area1, #area2{ position:relative;}
#area2{ margin-top:20px; }
#x_scale_setting_1, #x_scale_setting_2{
 position:absolute;
 border: solid 2px #666666;
 background-color:#dddddd;
 top:-5px;
 left:650px;
}

.form, .form_minor{
 z-index:15;
 display:none;
 position:absolute;
 border: solid 2px #666666;
 background-color:#ddffdd;
}
.form_minor{
 background-color:#dddddd;
}

#PU_1_rowinfo{
 left:0px;
 top:10px;
 width:190px;
 padding:10px;
}
#PU_2_entry{
 left: 220px;
 top:10px;
 width: 250px;
 padding: 10px;
}
#PU_3_agentinfo{
 left:500px;
 top:10px;
 width: 200px;
 padding: 10px;
}

#PU_1_agent_list{
 line-height:30px;
}
.item{
 margin-top:10px;
}

.mild_label{
 display: inline-block;
 background-color: #aaaaff;
 border: solid 2px #666666;
}
.mild_label_2{
 display: inline-block;
 background-color: #ffaaaa;
 border: solid 2px #666666;
}
#pop_up_overwriting{
 display:none;
 color:red;
}

#manual_param_check{ width:20px;}

span .button_wide{
 display: inline-block;
}
span .button_wide_selected{
 display: inline-block;
}

.button_wide, .button_delete, .button_wide_selected{
 margin: 2px;
 padding: 2px;
 border: 3px outset;
 background-color:#cccccc;
}

.button_wide, .button_delete{
 cursor:pointer;
}
.button_delete{
 background-color:#ff6666;
}
.button_wide_selected{
 background-color:#777777;
 border: 3px inset;
}
.button_wide:hover{
 background-color:#ffffff;
}
.button_delete:hover{
 background-color:#ffffff;
}

.button{
 background-color:#cccccc;
 display: inline-block;
 cursor: pointer;
 text-align: center;
 width: 40px;
 line-height: 40px;
 border: 3px outset;
 margin: 5px;
}
.button_invalid{
 background-color:#777777;
 display: inline-block;
 text-align: center;
 width: 40px;
 line-height: 40px;
 border: 3px inset;
 margin: 5px;
}
.x_scale_button{
 z-index:12;
 background-color:#cccccc;
 display: inline-block;
 cursor: pointer;
 text-align: center;
 width: 36px;
 line-height: 36px;
 border: 3px outset;
 margin: 3px;
}

#drug_row_container{
 position: absolute;
 z-index:10;
}
.drug_row{
 background-color:#ffeeaa;
 border: 1px solid;
}
.drug_row:hover{
 background-color:#ddccff;
}
.drug_row_hover{
 background-color:#ddccff;
 border: 1px solid;
}
.dose_each{
 cursor:pointer;
}
.dose_each:hover{
 border: 1px solid #ff0000;
 background-color:#ddccff;
}

.comp{
 position:absolute;
 left:-999px; 
 top:15px;
 width:0px;
}
.comp_inner{
 position:absolute;
 top:15px;
 background-color: rgba(99,99,99,0.3);
}
#comp_1{
 border:1px solid red;
}
#comp_2{
 border:1px solid blue;
}
#comp_3{
 border:1px solid green;
}
.compline{
 position:absolute;
 left:-999px; 
 top:15px;
 border: 0px; /* 1px solid black; */
 background-color: rgba(0,255,0,0.3);
 width: 50px;
 height: 0px;
}
#compline_12{}
#compline_13{}
#compline_10{
 top:200px;
 height:50px;
}

#compart_agent{
 position:absolute;
 top:35px;
 z-index:5;
}
.comp_info{
 position:absolute;
 top:15px;
}
.compline_info{
 position:absolute;
 top:45px;
}
#compline_info_in{
 white-space: nowrap;
}
</style>
</head>
<body onload="ready();document.getElementById('age').focus();" onkeydown="if(event.keyCode==13&&Setting.is_pop_up){dose_done();}if(event.keyCode==27){dose_close();}"><!--enter,esc-->
age:<input type="tel" id="age" value="60" onfocus="this.select();" oninput="load_patient();update_graph();">,
sex:<select id="sex" onchange="load_patient();update_graph();"><option value="0">M</option><option value="1" selected>F</option></select>,
height:<input type="tel" id="height" value="160" onfocus="this.select();" oninput="load_patient();update_graph();">cm,
TBW:<input type="tel" id="TBW" value="50" onfocus="this.select();" oninput="load_patient();update_graph();">kg,
ASA-PS: <select id="high_ASA" onchange="load_patient();update_graph();"><option value="0" selected>1,2</option><option value="1">3,4</option></select>
<br>
<span id="patient_info"></span>
<hr>
<div id="area1">
 <canvas id="canvas_1"></canvas>
 <canvas id="canvas_1_cursor"></canvas>
 <div id="drug_row_container"></div>

<!-- x-scale -->
 <form id="x_scale_setting_1">
  <span class="x_scale_button" onclick="scale_short();">+</span><span class="x_scale_button" onclick="scale_long();">-</span> <br>
  <span class="x_scale_button" onclick="scale_prev();">&lt;</span><span class="x_scale_button" onclick="scale_next();">&gt;</span>
 </form>

<!-- pop up 1 -->
 <div class="form" id="PU_1_rowinfo">
  <div id="PU_1_agent_list"></div>
<hr>
  <div class="button_wide" onclick="dose_close();">Cancel</div>
  <div class="button_delete" onclick="drug_delete();" id="delete_row_button">Delete row</div>
 </div>

<!--  pop up 2 -->
 <div class="form" id="PU_2_entry">
  <form onsubmit="event.preventDefault();dose_done();return false;">
   <span class="mild_label" id="pop_up_mode">Add mode</span>
   <span class="button_invalid" id="dose_prev_button" onclick="dose_prev();event.preventDefault();">prev</span>
   <span class="button_invalid" id="dose_next_button" onclick="dose_next();event.preventDefault();">next</span>
<br>
   Time: <input type="tel" id="entry_time" value=""> min
   <span id="pop_up_overwriting">Overwriting</span>
<br>
   <span class="button" onclick="entry_time_c(-10);">&lt;&lt;</span>
   <span class="button" onclick="entry_time_c(-1);">&lt;</span>
   <span class="button" onclick="entry_time_c(1);">&gt;</span>
   <span class="button" onclick="entry_time_c(10);">&gt;&gt;</span>
  </form>
<hr>
  <form onsubmit="event.preventDefault();dose_done();return false;">
   Dose:
   <input type="tel" id="dose" oninput="PU_change_val(null);">
   <span id="dose_unit"></span>
<br>
   <span class="button" onclick="dose_input(7)">7</span>
   <span class="button" onclick="dose_input(8)">8</span>
   <span class="button" onclick="dose_input(9)">9</span>
   <span class="button" onclick="dose_input('BS')">←</span>
<br>
   <span class="button" onclick="dose_input(4)">4</span>
   <span class="button" onclick="dose_input(5)">5</span>
   <span class="button" onclick="dose_input(6)">6</span>
   <span class="button" onclick="dose_input('clear')">clear</span>
<br>
   <span class="button" onclick="dose_input(1)">1</span>
   <span class="button" onclick="dose_input(2)">2</span>
   <span class="button" onclick="dose_input(3)">3</span>
   <span class="button" onclick="dose_close();">cancel</span>
<br>
   <span class="button" onclick="dose_input(0)">0</span>
   <span class="button" onclick="dose_input('.')">.</span>
   <span class="button" id="dose_done_button" style="width:100px;" onclick="dose_done();">OK</span>
<br>
   <div class="button_delete" onclick="dose_delete();" id="delete_entry_button">Delete entry</div>
  </form>
<hr>
  Model:
  <span class="button_wide" id="entry_preset" onclick="manual_param_to(false);">Preset</span>
  <span class="button_wide" id="entry_manual" onclick="manual_param_to(true);">Manual</span>
  <div id="PU_manual_model">
   <div class="item" i="0">V1=<input oninput="manual_param(this,true);"><span onclick="manual_param(this,false);" class="button_wide">default</span></div>
   <div class="item" i="1">V2=<input oninput="manual_param(this,true);"><span onclick="manual_param(this,false);" class="button_wide">default</span></div>
   <div class="item" i="2">V3=<input oninput="manual_param(this,true);"><span onclick="manual_param(this,false);" class="button_wide">default</span></div>
   <div class="item" i="3">CL=<input oninput="manual_param(this,true);"><span onclick="manual_param(this,false);" class="button_wide">default</span></div>
   <div class="item" i="4">Q2=<input oninput="manual_param(this,true);"><span onclick="manual_param(this,false);" class="button_wide">default</span></div>
   <div class="item" i="5">Q3=<input oninput="manual_param(this,true);"><span onclick="manual_param(this,false);" class="button_wide">default</span></div>
   <div class="item" i="6">ke=<input oninput="manual_param(this,true);"><span onclick="manual_param(this,false);" class="button_wide">default</span></div>
  </div>
 </div>

<!-- pop up 3: setting -->
 <div class="form_minor" id="PU_3_agentinfo" onsubmit="alert(3)">
  Label: <input type="tel" id="PU_3_agent" oninput="change_label(this);"><br>
  Color: <input type="color" id="PU_3_color"><br>
  Y-scale: <input type="tel" id="PU_3_scale">ng/mL<br>
  Conc.: <input type="tel" id="PU_3_mgmL" oninput="Setting.agentinfo.mgmL = parseFloat(this.value);">mg/mL<br>
<hr>
  Unit:
  <div id="select_bolus_unit">
   <div class="item"><input oninput="PU_change_val(this);"><span onclick="PU_change_unit(this,true);" class="button_wide">mg</span></div>
   <div class="item"><input oninput="PU_change_val(this);"><span onclick="PU_change_unit(this,true);" class="button_wide">mcg</span></div>
   <div class="item"><input oninput="PU_change_val(this);"><span onclick="PU_change_unit(this,true);" class="button_wide">mg/kg</span></div>
   <div class="item"><input oninput="PU_change_val(this);"><span onclick="PU_change_unit(this,true);" class="button_wide">mL</span></div>
  </div>
  <div id="select_infusion_unit">
   <div class="item"><input oninput="PU_change_val(this);"><span onclick="PU_change_unit(this,true);" class="button_wide">mg/h</span></div>
   <div class="item"><input oninput="PU_change_val(this);"><span onclick="PU_change_unit(this,true);" class="button_wide">mg/kg/h</span></div>
   <div class="item"><input oninput="PU_change_val(this);"><span onclick="PU_change_unit(this,true);" class="button_wide">mcg/kg/min</span></div>
   <div class="item"><input oninput="PU_change_val(this);"><span onclick="PU_change_unit(this,true);" class="button_wide">mcg/kg/h</span></div>
   <div class="item"><input oninput="PU_change_val(this);"><span onclick="PU_change_unit(this,true);" class="button_wide">mL/h</span></div>
   <div class="item"><input oninput="PU_change_val(this);"><span onclick="PU_change_unit(this,true);" class="button_wide">mcg/mL</span>(TCI)</div>
   <div class="item"><input oninput="PU_change_val(this);"><span onclick="PU_change_unit(this,true);" class="button_wide">ng/mL</span>(TCI)</div>
  </div>
  <div id="TCI_model"></div>
<hr>
  Preset model:
  <div id="preset_model"></div>
 </div>
</div>

<div id="area2">
 <canvas id="canvas_2"></canvas>
 <div class="comp" id="comp_1"><div class="comp_inner" id="comp_inner_1"></div></div>
 <div class="comp" id="comp_2"><div class="comp_inner" id="comp_inner_2"></div></div>
 <div class="comp" id="comp_3"><div class="comp_inner" id="comp_inner_3"></div></div>
 <div class="compline" id="compline_12"></div>
 <div class="compline" id="compline_13"></div>
 <div class="compline" id="compline_10"></div>
 <div class="comp_info" id="comp_info_1"></div>
 <div class="comp_info" id="comp_info_2"></div>
 <div class="comp_info" id="comp_info_3"></div>
 <div class="compline_info" id="compline_info_in"></div>
 <div class="compline_info" id="compline_info_12"></div>
 <div class="compline_info" id="compline_info_13"></div>
 <div class="compline_info" id="compline_info_10"></div>
 <div id="comp_out"></div>
 <div id="compart_agent"></div>
 <canvas id="canvas_2_cursor"></canvas>
 <form id="x_scale_setting_2">
  <span class="x_scale_button" onclick="scale_short();">+</span><span class="x_scale_button" onclick="scale_long();">-</span> <br>
  <span class="x_scale_button" onclick="scale_prev();">&lt;</span><span class="x_scale_button" onclick="scale_next();">&gt;</span>
 </form>
</div>

<hr>

<div>
Click the yellow bar between them to register dose information.<br>
First canvas: concentration of central compartment (solid line) and effect site (filled area)<br>
Second canvas: visualization of central (red), rapid peripheral (blue), and slow peripheral compartment (green)<br>
<br>
Setting:<br>
Model:<br>
P .. Eleveld, 2018 (using age,sex,height,TBW) [PMID: 29661412]<br>
  .. Marsh, 1991 (using TBW) (same as Diprifusor&copy; [PMID: 9640110])<br>
RMZ .. Masui, 2022 (using age,sex,height,TBW,ASA) [PMID: 35708787]<br>
    .. Doi, 2014 (using TBW) (ke unavailable) [日本臨床麻酔科学会誌 Vol.34 No.7 860-866, 2014]<br>
K .. Kamp, 2020 (using TBW) (ke unavailable) [PMID: 32997732]<br>
DEX .. Morse, 2020 (using age,sex,height,TBW) (ke unavailable) [PMID: 33126702]<br>
    .. Hannivoort, 2015 (using TBW) (ke unavailable) [PMID: 26068206]<br>
F .. Bae, 2020 (using TBW) [PMID: 32861508]<br>
  .. Shafer, 1990 (using TBW)<br>
RF .. Elevelt, 2017 (using age,sex,height,TBW) [PMID: 28509794]<br>
   .. Kim, 2017 (using age,sex,height,TBW) (ke unavailable) [PMID: 28509796]<br>
   .. Minto, 1997 (using age,sex,height,TBW)<br>
Rb .. Wierda, 1991 (using TBW) (ke unavailable)<br>
Vb .. Rupp, 1987 (using age,TBW) (apply younger [30-57] model for age&lt;64 and elderly [70-84] model otherwise) [PMID: 2886080]<br>
<br>
TBW: total body weight<br>
IBW: ideal body weight: (used by Masui)<br>
　45.4+0.89*(height-152.4)+4.5 for male<br>
　45.4+0.89*(height-152.4) for female<br>
ABW: adjusted body weight = IBW+0.4*(TBW-IBW) (used by Masui)<br>
LBM: lean body mass: (used by Minto)<br>
　1.1*TBW-128*(TBW/height)<sup>2</sup> for male<br>
　1.07*Weight-148*(TBW/height)<sup>2</sup> for female<br>
FFM<sub>j</sub>: fat free mass by Janmahasatian: (used by Kim)<br>
　9270*TBW/(6680+216*BMI) for male<br>
　9270*TBW/(8780+244*BMI) for female<br>
FFM<sub>AS</sub>: fat free mass by Al Sallami et al.: (used by Eleveld, Morse)<br>
　(0.88+(1-0.88)/(1+(age/13.4)<sup>-12.7</sup>))*FFM<sub>j</sub> for male<br>
　(1.11+(1-1.11)/(1+(age/7.1)<sup>-1.1</sup>))*FFM<sub>j</sub> for female<br>
<br>
review: [PMID: 35566617]<br>
<hr>
3-compartment model:<br>
<br>
dA1/dt = infusion_rate-CL*C1-Q2*(C1-C2)-Q3*(C1-C3) = infusion_rate-(k10+k12+k13)*A1+k21*A2+k31*A3<br>
dA2/dt = Q2*(C1-C2) = k12*A1-k21*A2<br>
dA3/dt = Q3*(C1-C3) = k13*A1-k31*A3<br>
dCe/dt = ke*(C1-Ce)<br>
<br>
A1,A2,A3: amount in each compartment [mg] (Ak=Ck*Vk)<br>
C1,C2,C3,Ce: concentration in each compartment [mg/L]<br>
CL,Q2,Q3: clearance [L/min]<br>
V1,V2,V3: volume of each compartment [L]<br>
k10=CL/V1, k12=Q2/V1, k13=Q3/V1, k21=Q2/V2, k31=Q3/V3 [min]<br>
<hr>
<a href="https://github.com/seazuma/pkpd">https://github.com/seazuma/pkpd</a><br>
2022/9/1 v1.1.2-under-dev<br>
2022/8/15 v1.0.0-alpha<br>
</div>
</body></html>
